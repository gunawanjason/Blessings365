<!DOCTYPE html>
<html lang="en" data-bs-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alkitab365</title>
  <link rel="icon" type="image/x-icon" href="/assets/bcc.ico" />
  <link rel="apple-touch-icon" href="/assets/bcc.ico" />
  <style>
    /* Basic styling for readability */
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap"
    rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
  <link rel="stylesheet" type="text/css" href="styles.css" />
  <link rel="stylesheet" type="text/css" href="verse-menu.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
    integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MBVE1FKX3R"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-MBVE1FKX3R');
  </script>
</head>

<body>
  <div class="fixed-width-container">
    <nav class="mt-4 mb-4 navbar navbar-expand-lg fixed-width-large">
      <div class="container-fluid popover-container d-flex justify-content-between align-items-center">
        <div class="navbar-nav-left d-flex align-items-center" style="flex: 1;">
          <a href="compare.html" class="btn btn-compare">Compare</a>
        </div>
        <a href="#" class="navbar-brand mb-0 h1 mx-auto text-center">
          Alkitab<span class="brand-accent">365</span>
        </a>
        <div class="navbar-nav-right d-flex justify-content-end align-items-center" style="flex: 1;">
          <button id="popoverBtn" class="btn settings-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="bi" fill="currentColor"
              viewBox="0 0 16 16">
              <path fill-rule="evenodd"
                d="M2.5 11.5A.5.5 0 0 1 3 11h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 7h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 3h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z">
              </path>
            </svg>
          </button>
        </div>
        <div class="popover" id="popoverContent">
          <div class="popover-header">Reader settings</div>
          <div class="popover-body">
            <!-- Font size option -->
            <div class="user-options font-size-option">
              <p class="mb-0">Font size</p>
              <div class="font-size-slider-container">
                <input type="range" min="1" max="3" value="2" step="1" class="font-size-slider" id="font-size-slider">
                <div class="font-size-labels">
                  <span><span class="font-size-example small-font-size">Aa</span> Small</span>
                  <span><span class="font-size-example medium-font-size">Aa</span> Medium</span>
                  <span><span class="font-size-example large-font-size">Aa</span> Large</span>
                </div>
              </div>
            </div>

            <!-- Dark mode option -->
            <div class="user-options toggle-option">
              <p class="mb-0">Appearance</p>
              <label class="toggle-label">
                <span class="toggle-icon">‚òÄÔ∏è</span>
                <div class="toggle-switch">
                  <input type="checkbox" id="mode-toggle">
                  <span class="toggle-slider"></span>
                </div>
                <span class="toggle-icon">üåô</span>
              </label>
            </div>

            <!-- Bold Copy option -->
            <div class="user-options toggle-option">
              <p class="mb-0">Copy Format</p>
              <label class="toggle-label">
                <span class="toggle-icon">Aa</span> <!-- Plain text icon -->
                <div class="toggle-switch">
                  <input type="checkbox" id="bold-copy-toggle">
                  <span class="toggle-slider"></span>
                </div>
                <span class="toggle-icon"><strong>A</strong>a</span> <!-- Better bold icon -->
              </label>
            </div>
          </div>
        </div>
      </div>
    </nav>
  </div>

  <div class="fixed-width-container">
    <!-- Dropdowns for selecting a month and a day -->
    <div class="d-flex justify-content-center fixed-width-medium">
      <div class="me-2">
        <label for="month-selector" class="selector-label">Date</label>
        <div class="custom-dropdown" id="month-dropdown">
          <div class="custom-dropdown-toggle" id="month-toggle">Month</div>
          <div class="custom-dropdown-menu" id="month-menu"></div>
        </div>
        <select id="month-selector" class="d-none"></select>
      </div>
      <div class="me-3">
        <label for="day-selector" class="selector-label"></label>
        <div class="custom-dropdown" id="day-dropdown">
          <div class="custom-dropdown-toggle" id="day-toggle">Day</div>
          <div class="custom-dropdown-menu" id="day-menu"></div>
        </div>
        <select id="day-selector" class="d-none"></select>
      </div>

      <!-- Dropdown for selecting a Bible version -->
      <div>
        <label for="translation-selector" class="selector-label">Version</label>
        <div class="custom-dropdown" id="translation-dropdown">
          <div class="custom-dropdown-toggle" id="translation-toggle">Version</div>
          <div class="custom-dropdown-menu" id="translation-menu">
            <div class="custom-dropdown-item" data-value="TB">TB</div>
            <div class="custom-dropdown-item" data-value="ESV">ESV</div>
            <div class="custom-dropdown-item" data-value="KJV">KJV</div>
            <div class="custom-dropdown-item" data-value="NASB">NASB</div>
            <div class="custom-dropdown-item" data-value="NIV">NIV</div>
            <div class="custom-dropdown-item" data-value="NLT">NLT</div>
            <div class="custom-dropdown-item" data-value="TLB">TLB</div>
            <div class="custom-dropdown-item" data-value="CNVS">Êñ∞ËØëÊú¨(CNVS)</div>
            <div class="custom-dropdown-item" data-value="CUNPSS-‰∏äÂ∏ù">Êñ∞Ê†áÁÇπÂíåÂêàÊú¨Ôºå‰∏äÂ∏ùÁâà</div>
            <div class="custom-dropdown-item" data-value="CUNPSS-Á•û">Êñ∞Ê†áÁÇπÂíåÂêàÊú¨ÔºåÁ•ûÁâà</div>
            <div class="custom-dropdown-item" data-value="CUV">ÂíåÂêàÊú¨ (ÁπÅÈ´î) (CUV)</div>
          </div>
        </div>
        <select id="translation-selector" class="d-none">
          <option value="TB">TB</option>
          <option value="ESV">ESV</option>
          <option value="KJV">KJV</option>
          <option value="NASB">NASB</option>
          <option value="NIV">NIV</option>
          <option value="NLT">NLT</option>
          <option value="TLB">TLB</option>
          <option value="CNVS">Êñ∞ËØëÊú¨(CNVS)</option>
          <option value="CUNPSS-‰∏äÂ∏ù">Êñ∞Ê†áÁÇπÂíåÂêàÊú¨Ôºå‰∏äÂ∏ùÁâà</option>
          <option value="CUNPSS-Á•û">Êñ∞Ê†áÁÇπÂíåÂêàÊú¨ÔºåÁ•ûÁâà</option>
          <option value="CUV">ÂíåÂêàÊú¨ (ÁπÅÈ´î) (CUV)</option>
        </select>
      </div>

    </div>


  </div>

  <!-- Display the verses for the selected day and version -->
  <div class="fixed-width-container">
    <div id="verses-output" class="fixed-width-small"></div>
    <!-- Verse menu for sharing and copying -->
    <div id="verse-menu" class="verse-menu">
      <div class="verse-menu-item" id="copy-verse">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
        </svg>
        COPY
      </div>
    </div>
  </div>

  <script>
    // Helper function to get current Bible version
    function getCurrentVersion() {
      const selector = document.getElementById('translation-selector');
      return selector ? selector.value : 'unknown'; // Handle case where selector might not exist yet
    }

    // Core State Variables
    let currentMode = "light";
    let fontSize = "medium-font-size";
    const modeToButton = { light: "dark", dark: "light" };
    let selectedVerses = [];
    let selectedVersesAddress = "";
    let verseMenu;
    let boldCopyEnabled = true;

    // Initialize core elements
    document.addEventListener('DOMContentLoaded', () => {
      verseMenu = document.getElementById('verse-menu');
    });

    function setCookie(cname, cvalue, exdays) {
      const d = new Date();
      d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000);
      let expires = "expires=" + d.toUTCString();
      document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
      let name = cname + "=";
      let ca = document.cookie.split(";");
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == " ") {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }

    // Fetch the Translated_Bacaan_Alkitab_365.json directly from the current directory
    fetch("Translated_Bacaan_Alkitab_365.json")
      .then((response) => response.json())
      .then((translatedData) => {
        // Store in local storage for later use
        localStorage.setItem(
          "translatedData",
          JSON.stringify(translatedData)
        );

        populateMonthDayDropdowns(translatedData);

        // Load saved version from cookie before initial fetch
        const savedVersion = getCookie("selectedVersion");
        if (savedVersion) {
          document.getElementById("translation-selector").value = savedVersion;
        }

        // Auto fetch verses when page loads
        fetchVerses();
      })
      .catch((error) => {
        console.error(
          "Error fetching the Translated_Bacaan_Alkitab_365.json:",
          error
        );
      });

    const englishToIndonesianBooks = {
      Genesis: "Kejadian",
      Exodus: "Keluaran",
      Leviticus: "Imamat",
      Numbers: "Bilangan",
      Deuteronomy: "Ulangan",
      Joshua: "Yosua",
      Judges: "Hakim-Hakim",
      Ruth: "Rut",
      "1 Samuel": "1 Samuel",
      "2 Samuel": "2 Samuel",
      "1 Kings": "1 Raja-Raja",
      "2 Kings": "2 Raja-Raja",
      "1 Chronicles": "1 Tawarikh",
      "2 Chronicles": "2 Tawarikh",
      Ezra: "Ezra",
      Nehemiah: "Nehemia",
      Esther: "Ester",
      Job: "Ayub",
      Psalms: "Mazmur",
      Proverbs: "Amsal",
      Ecclesiastes: "Pengkhotbah",
      "Song of Solomon": "Kidung Agung",
      Isaiah: "Yesaya",
      Jeremiah: "Yeremia",
      Lamentations: "Ratapan",
      Ezekiel: "Yehezkiel",
      Daniel: "Daniel",
      Hosea: "Hosea",
      Joel: "Yoel",
      Amos: "Amos",
      Obadiah: "Obaja",
      Jonah: "Yunus",
      Micah: "Mikha",
      Nahum: "Nahum",
      Habakkuk: "Habakuk",
      Zephaniah: "Zefanya",
      Haggai: "Hagai",
      Zechariah: "Zakharia",
      Malachi: "Maleakhi",
      Matthew: "Matius",
      Mark: "Markus",
      Luke: "Lukas",
      John: "Yohanes",
      Acts: "Kisah Para Rasul",
      Romans: "Roma",
      "1 Corinthians": "1 Korintus",
      "2 Corinthians": "2 Korintus",
      Galatians: "Galatia",
      Ephesians: "Efesus",
      Philippians: "Filipi",
      Colossians: "Kolose",
      "1 Thessalonians": "1 Tesalonika",
      "2 Thessalonians": "2 Tesalonika",
      "1 Timothy": "1 Timotius",
      "2 Timothy": "2 Timotius",
      Titus: "Titus",
      Philemon: "Filemon",
      Hebrews: "Ibrani",
      James: "Yakobus",
      "1 Peter": "1 Petrus",
      "2 Peter": "2 Petrus",
      "1 John": "1 Yohanes",
      "2 John": "2 Yohanes",
      "3 John": "3 Yohanes",
      Jude: "Yudas",
      Revelation: "Wahyu",
    };

    const englishToChineseBooks = {
      Genesis: "Âàõ‰∏ñÁ∫™",
      Exodus: "Âá∫ÂüÉÂèäËÆ∞",
      Leviticus: "Âà©Êú™ËÆ∞",
      Numbers: "Ê∞ëÊï∞ËÆ∞",
      Deuteronomy: "Áî≥ÂëΩËÆ∞",
      Joshua: "Á∫¶‰π¶‰∫öËÆ∞",
      Judges: "Â£´Â∏àËÆ∞",
      Ruth: "Ë∑ØÂæóËÆ∞",
      "1 Samuel": "ÊííÊØçËÄ≥ËÆ∞‰∏ä",
      "2 Samuel": "ÊííÊØçËÄ≥ËÆ∞‰∏ã",
      "1 Kings": "ÂàóÁéãËÆ∞‰∏ä",
      "2 Kings": "ÂàóÁéãËÆ∞‰∏ã",
      "1 Chronicles": "ÂéÜ‰ª£Âøó‰∏ä",
      "2 Chronicles": "ÂéÜ‰ª£Âøó‰∏ã",
      Ezra: "‰ª•ÊñØÊãâËÆ∞",
      Nehemiah: "Â∞ºÂ∏åÁ±≥ËÆ∞",
      Esther: "‰ª•ÊñØÂ∏ñËÆ∞",
      Job: "Á∫¶‰ºØËÆ∞",
      Psalms: "ËØóÁØá",
      Proverbs: "ÁÆ¥Ë®Ä",
      Ecclesiastes: "‰º†ÈÅì‰π¶",
      "Song of Solomon": "ÈõÖÊ≠å",
      Isaiah: "‰ª•Ëµõ‰∫ö‰π¶",
      Jeremiah: "ËÄ∂Âà©Á±≥‰π¶",
      Lamentations: "ËÄ∂Âà©Á±≥ÂìÄÊ≠å",
      Ezekiel: "‰ª•Ë•øÁªì‰π¶",
      Daniel: "‰ΩÜ‰ª•ÁêÜ‰π¶",
      Hosea: "‰ΩïË•øÈòø‰π¶",
      Joel: "Á∫¶Áè•‰π¶",
      Amos: "ÈòøÊë©Âè∏‰π¶",
      Obadiah: "‰øÑÂ∑¥Â∫ï‰∫ö‰π¶",
      Jonah: "Á∫¶Êãø‰π¶",
      Micah: "Âº•Ëø¶‰π¶",
      Nahum: "ÈÇ£È∏ø‰π¶",
      Habakkuk: "ÂìàÂ∑¥Ë∞∑‰π¶",
      Zephaniah: "Ë•øÁï™ÈõÖ‰π¶",
      Haggai: "ÂìàËØ•‰π¶",
      Zechariah: "ÊííËø¶Âà©‰∫ö‰π¶",
      Malachi: "ÁéõÊãâÂü∫‰π¶",
      Matthew: "È©¨Â§™Á¶èÈü≥",
      Mark: "È©¨ÂèØÁ¶èÈü≥",
      Luke: "Ë∑ØÂä†Á¶èÈü≥",
      John: "Á∫¶Áø∞Á¶èÈü≥",
      Acts: "‰ΩøÂæíË°å‰º†",
      Romans: "ÁΩóÈ©¨‰π¶",
      "1 Corinthians": "Ê≠åÊûóÂ§öÂâç‰π¶",
      "2 Corinthians": "Ê≠åÊûóÂ§öÂêé‰π¶",
      Galatians: "Âä†ÊãâÂ§™‰π¶",
      Ephesians: "‰ª•ÂºóÊâÄ‰π¶",
      Philippians: "ËÖìÂà©ÊØî‰π¶",
      Colossians: "Ê≠åÁΩóË•ø‰π¶",
      "1 Thessalonians": "Â∏ñÊííÁΩóÂ∞ºËø¶Ââç‰π¶",
      "2 Thessalonians": "Â∏ñÊííÁΩóÂ∞ºËø¶Âêé‰π¶",
      "1 Timothy": "ÊèêÊë©Â§™Ââç‰π¶",
      "2 Timothy": "ÊèêÊë©Â§™Âêé‰π¶",
      Titus: "ÊèêÂ§ö‰π¶",
      Philemon: "ËÖìÂà©Èó®‰π¶",
      Hebrews: "Â∏å‰ºØÊù•‰π¶",
      James: "ÈõÖÂêÑ‰π¶",
      "1 Peter": "ÂΩºÂæóÂâç‰π¶",
      "2 Peter": "ÂΩºÂæóÂêé‰π¶",
      "1 John": "Á∫¶Áø∞‰∏Ä‰π¶",
      "2 John": "Á∫¶Áø∞‰∫å‰π¶",
      "3 John": "Á∫¶Áø∞‰∏â‰π¶",
      Jude: "ÁäπÂ§ß‰π¶",
      Revelation: "ÂêØÁ§∫ÂΩï",
    };


    const englishToTraditionalChineseBooks = {
      Genesis: "Ââµ‰∏ñË®ò",
      Exodus: "Âá∫ÂüÉÂèäË®ò",
      Leviticus: "Âà©Êú™Ë®ò",
      Numbers: "Ê∞ëÊï∏Ë®ò",
      Deuteronomy: "Áî≥ÂëΩË®ò",
      Joshua: "Á¥ÑÊõ∏‰∫ûË®ò",
      Judges: "Â£´Â∏´Ë®ò",
      Ruth: "Ë∑ØÂæóË®ò",
      "1 Samuel": "ÊííÊØçËÄ≥Ë®ò‰∏ä",
      "2 Samuel": "ÊííÊØçËÄ≥Ë®ò‰∏ã",
      "1 Kings": "ÂàóÁéãÁ¥Ä‰∏ä",
      "2 Kings": "ÂàóÁéãÁ¥Ä‰∏ã",
      "1 Chronicles": "Ê≠∑‰ª£Âøó‰∏ä",
      "2 Chronicles": "Ê≠∑‰ª£Âøó‰∏ã",
      Ezra: "‰ª•ÊñØÊãâË®ò",
      Nehemiah: "Â∞ºÂ∏åÁ±≥Ë®ò",
      Esther: "‰ª•ÊñØÂ∏ñË®ò",
      Job: "Á¥Ñ‰ºØË®ò",
      Psalms: "Ë©©ÁØá",
      Proverbs: "ÁÆ¥Ë®Ä",
      Ecclesiastes: "ÂÇ≥ÈÅìÊõ∏",
      "Song of Solomon": "ÈõÖÊ≠å",
      Isaiah: "‰ª•Ë≥Ω‰∫ûÊõ∏",
      Jeremiah: "ËÄ∂Âà©Á±≥Êõ∏",
      Lamentations: "ËÄ∂Âà©Á±≥ÂìÄÊ≠å",
      Ezekiel: "‰ª•Ë•øÁµêÊõ∏",
      Daniel: "‰ΩÜ‰ª•ÁêÜÊõ∏",
      Hosea: "‰ΩïË•øÈòøÊõ∏",
      Joel: "Á¥ÑÁè•Êõ∏",
      Amos: "ÈòøÊë©Âè∏Êõ∏",
      Obadiah: "‰øÑÂ∑¥Â∫ï‰∫ûÊõ∏",
      Jonah: "Á¥ÑÊãøÊõ∏",
      Micah: "ÂΩåËø¶Êõ∏",
      Nahum: "ÈÇ£È¥ªÊõ∏",
      Habakkuk: "ÂìàÂ∑¥Ë∞∑Êõ∏",
      Zephaniah: "Ë•øÁï™ÈõÖÊõ∏",
      Haggai: "ÂìàË©≤Êõ∏",
      Zechariah: "ÊííËø¶Âà©‰∫ûÊõ∏",
      Malachi: "Áë™ÊãâÂü∫Êõ∏",
      Matthew: "È¶¨Â§™Á¶èÈü≥",
      Mark: "È¶¨ÂèØÁ¶èÈü≥",
      Luke: "Ë∑ØÂä†Á¶èÈü≥",
      John: "Á¥ÑÁø∞Á¶èÈü≥",
      Acts: "‰ΩøÂæíË°åÂÇ≥",
      Romans: "ÁæÖÈ¶¨Êõ∏",
      "1 Corinthians": "Âì•ÊûóÂ§öÂâçÊõ∏",
      "2 Corinthians": "Âì•ÊûóÂ§öÂæåÊõ∏",
      Galatians: "Âä†ÊãâÂ§™Êõ∏",
      Ephesians: "‰ª•ÂºóÊâÄÊõ∏",
      Philippians: "ËÖìÁ´ãÊØîÊõ∏",
      Colossians: "Ê≠åÁæÖË•øÊõ∏",
      "1 Thessalonians": "Â∏ñÊííÁæÖÂ∞ºËø¶ÂâçÊõ∏",
      "2 Thessalonians": "Â∏ñÊííÁæÖÂ∞ºËø¶ÂæåÊõ∏",
      "1 Timothy": "ÊèêÊë©Â§™ÂâçÊõ∏",
      "2 Timothy": "ÊèêÊë©Â§™ÂæåÊõ∏",
      Titus: "ÊèêÂ§öÊõ∏",
      Philemon: "ËÖìÂà©ÈñÄÊõ∏",
      Hebrews: "Â∏å‰ºØ‰æÜÊõ∏",
      James: "ÈõÖÂêÑÊõ∏",
      "1 Peter": "ÂΩºÂæóÂâçÊõ∏",
      "2 Peter": "ÂΩºÂæóÂæåÊõ∏",
      "1 John": "Á¥ÑÁø∞‰∏ÄÊõ∏",
      "2 John": "Á¥ÑÁø∞‰∫åÊõ∏",
      "3 John": "Á¥ÑÁø∞‰∏âÊõ∏",
      Jude: "Áå∂Â§ßÊõ∏",
      Revelation: "ÂïüÁ§∫ÈåÑ",
    };
    function isLeapYear(year) {
      return (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0;
    }

    function dayOfYear(date) {
      const start = new Date(date.getFullYear(), 0, 0);
      const diff =
        date -
        start +
        (start.getTimezoneOffset() - date.getTimezoneOffset()) * 60 * 1000;
      const oneDay = 1000 * 60 * 60 * 24;
      let day = Math.floor(diff / oneDay);

      // Adjust day count in leap years after February 29
      if (
        isLeapYear(date.getFullYear()) &&
        ((date.getMonth() === 1 && date.getDate() === 29) ||
          date.getMonth() > 1)
      ) {
        day -= 1;
      }

      return day;
    }

    function updateCustomDropdown(selectId) {
      const select = document.getElementById(selectId);
      const dropdownId = selectId.split('-')[0] + '-dropdown';
      const menuId = selectId.split('-')[0] + '-menu';
      const toggleId = selectId.split('-')[0] + '-toggle';

      const menu = document.getElementById(menuId);
      const toggle = document.getElementById(toggleId);

      if (!menu || !toggle) return;

      menu.innerHTML = '';
      Array.from(select.options).forEach(option => {
        const item = document.createElement('div');
        item.className = 'custom-dropdown-item';
        if (option.value === select.value) item.classList.add('active');
        item.dataset.value = option.value;
        item.textContent = option.textContent;

        item.addEventListener('click', () => {
          select.value = option.value;
          select.dispatchEvent(new Event('change'));
          updateCustomDropdown(selectId);
        });

        menu.appendChild(item);
      });

      const selectedOption = select.options[select.selectedIndex];
      toggle.textContent = selectedOption ? selectedOption.textContent : '';
    }

    function populateMonthDayDropdowns(translatedData) {
      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December",
      ];
      const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

      const monthSelector = document.getElementById("month-selector");
      const daySelector = document.getElementById("day-selector");

      monthNames.forEach((month, index) => {
        const option = document.createElement("option");
        option.value = index + 1;
        option.textContent = month;
        monthSelector.appendChild(option);
      });

      function fillDays() {
        daySelector.innerHTML = "";
        const selectedMonth = parseInt(monthSelector.value);
        const currentYear = new Date().getFullYear();
        if (isLeapYear(currentYear) && selectedMonth === 2) {
          daysInMonth[selectedMonth - 1] = 29;
        }
        for (let i = 1; i <= daysInMonth[selectedMonth - 1]; i++) {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = i;
          daySelector.appendChild(option);
        }
        updateCustomDropdown('day-selector');
      }

      fillDays();

      monthSelector.addEventListener("change", (event) => {
        fillDays();
        updateCustomDropdown('month-selector');
        fetchVerses();
        if (typeof gtag === 'function') {
          gtag('event', 'select_content', {
            'content_type': 'date_month',
            'item_id': event.target.value,
            'selected_version': getCurrentVersion()
          });
        }
      });

      daySelector.addEventListener("change", (event) => {
        displayReferences(translatedData);
        updateCustomDropdown('day-selector');
        fetchVerses();
        if (typeof gtag === 'function') {
          gtag('event', 'select_content', {
            'content_type': 'date_day',
            'item_id': event.target.value,
            'selected_version': getCurrentVersion()
          });
        }
      });

      // Handle translation selector for custom dropdown
      const translationSelector = document.getElementById("translation-selector");
      translationSelector.addEventListener("change", (event) => {
        const selectedVersion = event.target.value;
        setCookie("selectedVersion", selectedVersion, 365);
        updateCustomDropdown('translation-selector');
        fetchVerses();
        if (typeof gtag === 'function') {
          gtag('event', 'select_content', {
            'content_type': 'bible_version',
            'item_id': selectedVersion
          });
        }
      });

      // Global click handler for dropdown toggles
      document.addEventListener('click', (e) => {
        const toggle = e.target.closest('.custom-dropdown-toggle');
        const dropdown = e.target.closest('.custom-dropdown');

        // Close all other dropdowns
        document.querySelectorAll('.custom-dropdown').forEach(d => {
          if (d !== dropdown) {
            d.classList.remove('active');
            d.querySelector('.custom-dropdown-menu').classList.remove('show');
          }
        });

        if (toggle && dropdown) {
          dropdown.classList.toggle('active');
          dropdown.querySelector('.custom-dropdown-menu').classList.toggle('show');
        } else if (!dropdown) {
          // Clicked outside any dropdown
          document.querySelectorAll('.custom-dropdown').forEach(d => {
            d.classList.remove('active');
            d.querySelector('.custom-dropdown-menu').classList.remove('show');
          });
        }
      });

      function updateVerseSelectionHeader() {
        const headerDiv = document.getElementById('verseSelectionHeader');
        const contentDiv = document.getElementById('verseSelectionHeaderContent');

        if (selectedVerses.length > 0 && selectedVersesAddress) {
          contentDiv.textContent = `Selected: ${selectedVersesAddress}`;
          headerDiv.style.display = 'block';
        } else {
          contentDiv.textContent = '';
          headerDiv.style.display = 'none';
        }
      }

      // Handle verse selection and menu display
      document.addEventListener('click', function (e) {
        const verseDiv = e.target.closest('.verse-div');
        if (verseDiv) {
          e.preventDefault();

          // Toggle selection for the clicked verse
          if (selectedVerses.includes(verseDiv)) {
            verseDiv.classList.remove('verse-selected');
            selectedVerses = selectedVerses.filter(v => v !== verseDiv);
          } else {
            verseDiv.classList.add('verse-selected');
            selectedVerses.push(verseDiv);
          }

          // Show or hide menu based on selection state
          if (selectedVerses.length > 0) {
            // Position menu directly on top of the last selected verse
            const lastVerse = selectedVerses[selectedVerses.length - 1];
            const rect = lastVerse.getBoundingClientRect();
            // Position the menu directly on top of the verse
            verseMenu.style.top = `${window.scrollY + rect.top + (rect.height / 2)}px`;
            verseMenu.style.left = `${rect.right - 70}px`; // Position from right side
            verseMenu.style.display = 'block';

            // Update verse address selection
            const { _, formattedHeader } = formatVerseSelection(selectedVerses);
            selectedVersesAddress = formattedHeader;
            updateVerseSelectionHeader();
          } else {
            verseMenu.style.display = 'none';
            selectedVersesAddress = "";
            updateVerseSelectionHeader();
          }
        } else if (!e.target.closest('#verse-menu')) {
          // Close menu and clear selections if clicking outside verses and menu
          verseMenu.style.display = 'none';
          selectedVerses.forEach(v => v.classList.remove('verse-selected'));
          selectedVerses = [];
          selectedVersesAddress = "";
          updateVerseSelectionHeader();
        }
      });

      const today = new Date();
      monthSelector.value = today.getMonth() + 1;
      fillDays();
      daySelector.value = today.getDate();
      if (isLeapYear(today.getFullYear()) && today.getMonth() === 1 && today.getDate() === 29) {
        daySelector.value = 29;
      }

      updateCustomDropdown('month-selector');
      updateCustomDropdown('day-selector');
      updateCustomDropdown('translation-selector');

      displayReferences(translatedData);
    }

    function displayReferences(translatedData) {
      const selectedMonth = parseInt(
        document.getElementById("month-selector").value
      );
      const selectedDay = parseInt(
        document.getElementById("day-selector").value
      );
      const date = new Date(
        new Date().getFullYear(),
        selectedMonth - 1,
        selectedDay
      );
      const dayOfYearValue = dayOfYear(date);
      const referencesDiv = document.getElementById("daily-references");
      if (referencesDiv) {
        referencesDiv.textContent = translatedData[dayOfYearValue].join(", ");
      }
    }

    function displayVerses(data, translation) {
      const outputDiv = document.getElementById("verses-output");
      outputDiv.innerHTML = "";

      // create accordion div
      const accordionDiv = document.createElement("div");
      accordionDiv.classList.add("accordion", "accordion-flush");
      accordionDiv.setAttribute("id", "versesAccordion");
      outputDiv.appendChild(accordionDiv);

      let currentBook = "";
      let currentItem, currentBody;

      let startVerse = "";
      let prevVerse = "";
      let prevButton;

      function formatBookName(bookName) {
        // Split the input into words
        const words = bookName.split(" ");

        // Initialize an array for non-numeric parts and numeric parts
        const nonNumericParts = [];
        const numericParts = [];

        // Separate non-numeric and numeric parts
        for (const word of words) {
          if (isNaN(word)) {
            nonNumericParts.push(word);
          } else {
            numericParts.push(word);
          }
        }

        // Join the non-numeric parts with hyphens and add the numeric parts at the end
        const formattedString =
          nonNumericParts.join("-").toLowerCase() + numericParts.join("");

        return formattedString;
      }

      for (const verseData of data) {
        let bookName = verseData.book;

        if (bookName !== currentBook) {
          // create accordion-item div
          currentItem = document.createElement("div");
          currentItem.classList.add("accordion-item");
          accordionDiv.appendChild(currentItem);

          // create accordion-header h2
          let currentHeader = document.createElement("h2");
          currentHeader.classList.add("accordion-header");
          currentHeader.setAttribute(
            "id",
            formatBookName(bookName) + "-heading"
          );
          currentItem.appendChild(currentHeader);

          // create button
          let currentButton = document.createElement("button");
          currentButton.className = "accordion-button collapsed";
          currentButton.type = "button";
          currentButton.setAttribute("data-bs-toggle", "collapse");
          currentButton.setAttribute(
            "data-bs-target",
            "#" + formatBookName(bookName) + "-collapse"
          );
          currentButton.setAttribute("aria-expanded", "false");
          currentButton.setAttribute(
            "aria-controls",
            formatBookName(bookName) + "-collapse"
          );
          currentButton.setAttribute(
            "id",
            formatBookName(bookName) + "-button"
          );
          currentButton.textContent = bookName; // title for accordion item
          currentHeader.appendChild(currentButton);

          // create accordion-collapse div
          let currentCollapse = document.createElement("div");
          currentCollapse.className = "accordion-collapse collapse";
          currentCollapse.setAttribute(
            "id",
            formatBookName(bookName) + "-collapse"
          );
          currentCollapse.setAttribute(
            "aria-labelledby",
            formatBookName(bookName) + "-heading"
          );
          currentItem.appendChild(currentCollapse);

          // create accordion-body div
          currentBody = document.createElement("div");
          currentBody.className = "accordion-body";
          currentCollapse.appendChild(currentBody);

          // update accordion item title
          if (currentBook) {
            prevButton = document.getElementById(
              formatBookName(currentBook) + "-button"
            );
            if (
              translation === "TB" &&
              englishToIndonesianBooks[currentBook]
            ) {
              currentBook = englishToIndonesianBooks[currentBook];
            } else if (
              (translation === "CNVS" ||
                translation === "CUNPSS-‰∏äÂ∏ù" ||
                translation === "CUNPSS-Á•û") &&
              englishToChineseBooks[currentBook]
            ) {
              currentBook = englishToChineseBooks[currentBook];
            } else if (
              translation === "CUV" &&
              englishToTraditionalChineseBooks[currentBook]
            ) {
              currentBook = englishToTraditionalChineseBooks[currentBook];
            }

            // 25:6-8 instead of 25:6-25:8
            if (startVerse.split(":")[0] === prevVerse.split(":")[0]) {
              prevVerse = prevVerse.split(":")[1];
            }

            prevButton.textContent = `${currentBook} ${startVerse}-${prevVerse}`;
          }

          // update for new book
          currentBook = bookName;
          startVerse = `${verseData.chapter}:${verseData.verse}`;
        }

        // set bookName for display of next verse
        if (translation === "TB" && englishToIndonesianBooks[bookName]) {
          bookName = englishToIndonesianBooks[bookName];
        } else if (
          (translation === "CNVS" ||
            translation === "CUNPSS-‰∏äÂ∏ù" ||
            translation === "CUNPSS-Á•û") &&
          englishToChineseBooks[bookName]
        ) {
          bookName = englishToChineseBooks[bookName];
        } else if (
          translation === "CUV" &&
          englishToTraditionalChineseBooks[bookName]
        ) {
          bookName = englishToTraditionalChineseBooks[bookName];
        }
        const verseDiv = document.createElement("div");
        verseDiv.className = `verse-div ${fontSize}`;
        verseDiv.innerHTML = `<strong><sup>${verseData.chapter}:${verseData.verse}</sup></strong> ${verseData.content}`;
        currentBody.appendChild(verseDiv);

        prevVerse = `${verseData.chapter}:${verseData.verse}`;
      }

      // update accordion item title for last book
      if (currentBook) {
        prevButton = document.getElementById(
          formatBookName(currentBook) + "-button"
        );
        if (translation === "TB" && englishToIndonesianBooks[currentBook]) {
          currentBook = englishToIndonesianBooks[currentBook];
        } else if (
          (translation === "CNVS" ||
            translation === "CUNPSS-‰∏äÂ∏ù" ||
            translation === "CUNPSS-Á•û") &&
          englishToChineseBooks[currentBook]
        ) {
          currentBook = englishToChineseBooks[currentBook];
        } else if (
          translation === "CUV" &&
          englishToTraditionalChineseBooks[currentBook]
        ) {
          currentBook = englishToTraditionalChineseBooks[currentBook];
        }

        // 25:6-8 instead of 25:6-25:8
        if (startVerse.split(":")[0] === prevVerse.split(":")[0]) {
          prevVerse = prevVerse.split(":")[1];
        }

        prevButton.textContent = `${currentBook} ${startVerse}-${prevVerse}`;
      }
    }

    function fetchVerses() {
      const translatedData = JSON.parse(
        localStorage.getItem("translatedData")
      );
      if (!translatedData) return;

      const month = document.getElementById("month-selector").value;
      const day = document.getElementById("day-selector").value;
      const translation = getCurrentVersion();

      const date = new Date(new Date().getFullYear(), month - 1, day);
      const verses = translatedData[dayOfYear(date)].join(",");

      // Show loading indicator
      const outputDiv = document.getElementById("verses-output");
      outputDiv.innerHTML = `
          <div class="d-flex justify-content-center my-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        `;

      const url = `https://api.blessings365.top/${translation}/multiple?verses=${encodeURIComponent(verses)}`;

      // GA Event
      if (typeof gtag === 'function') {
        gtag('event', 'view_item_list', {
          'item_list_name': 'Bible Verses',
          'items': [
            {
              'item_id': `day_${dayOfYear(date)}`,
              'item_name': `Reading for Day ${dayOfYear(date)}`,
              'item_category': translation
            }
          ],
          'selected_version': translation,
          'selected_month': month,
          'selected_day': day
        });
      }

      fetch(url)
        .then((response) => response.json())
        .then((data) => {
          displayVerses(data, translation);
        })
        .catch((error) => {
          console.error("Error fetching verses:", error);
          outputDiv.innerHTML = `
              <div class="alert alert-danger" role="alert">
                Error loading verses. Please try again.
              </div>
            `;
        });
    }

    // Unicode bold mapping (add more characters as needed)
    const boldMap = {
      'A': 'ùóî', 'B': 'ùóï', 'C': 'ùóñ', 'D': 'ùóó', 'E': 'ùóò', 'F': 'ùóô', 'G': 'ùóö', 'H': 'ùóõ', 'I': 'ùóú', 'J': 'ùóù', 'K': 'ùóû', 'L': 'ùóü', 'M': 'ùó†', 'N': 'ùó°', 'O': 'ùó¢', 'P': 'ùó£', 'Q': 'ùó§', 'R': 'ùó•', 'S': 'ùó¶', 'T': 'ùóß', 'U': 'ùó®', 'V': 'ùó©', 'W': 'ùó™', 'X': 'ùó´', 'Y': 'ùó¨', 'Z': 'ùó≠',
      'a': 'ùóÆ', 'b': 'ùóØ', 'c': 'ùó∞', 'd': 'ùó±', 'e': 'ùó≤', 'f': 'ùó≥', 'g': 'ùó¥', 'h': 'ùóµ', 'i': 'ùó∂', 'j': 'ùó∑', 'k': 'ùó∏', 'l': 'ùóπ', 'm': 'ùó∫', 'n': 'ùóª', 'o': 'ùóº', 'p': 'ùóΩ', 'q': 'ùóæ', 'r': 'ùóø', 's': 'ùòÄ', 't': 'ùòÅ', 'u': 'ùòÇ', 'v': 'ùòÉ', 'w': 'ùòÑ', 'x': 'ùòÖ', 'y': 'ùòÜ', 'z': 'ùòá',
      '0': 'ùü¨', '1': 'ùü≠', '2': 'ùüÆ', '3': 'ùüØ', '4': 'ùü∞', '5': 'ùü±', '6': 'ùü≤', '7': 'ùü≥', '8': 'ùü¥', '9': 'ùüµ',
      ' ': ' ', ':': ':', '-': '-', '(': '(', ')': ')', ',': ',', '.': '.', '(': '(', ')': ')' // Keep some punctuation as is, add parentheses
    };

    function toUnicodeBold(str) {
      return str.split('').map(char => boldMap[char] || char).join('');
    }

    function formatVerseSelection(selectedVerses) {
      if (selectedVerses.length > 0) {
        // 1. Sort verses by their position in the document
        const sortedVerses = [...selectedVerses].sort((a, b) => {
          const position = a.compareDocumentPosition(b);
          if (position & Node.DOCUMENT_POSITION_FOLLOWING) return -1;
          if (position & Node.DOCUMENT_POSITION_PRECEDING) return 1;
          return 0;
        });

        const translation = getCurrentVersion();
        const allVerseData = [];

        // 2. Extract detailed info for each verse
        sortedVerses.forEach(verseDiv => {
          const supElement = verseDiv.querySelector('sup');
          if (!supElement) return; // Skip if no sup tag found

          const chapterVerse = supElement.textContent; // e.g., "7:12"
          const [chapterStr, verseStr] = chapterVerse.split(':');
          const chapter = parseInt(chapterStr, 10);
          const verseNum = parseInt(verseStr, 10);

          // Get book name from the accordion button text
          const accordionBody = verseDiv.closest('.accordion-body');
          const accordionItem = accordionBody ? accordionBody.closest('.accordion-item') : null;
          const button = accordionItem ? accordionItem.querySelector('.accordion-button') : null;
          let bookName = 'Unknown Book';
          if (button) {
            const buttonText = button.textContent;
            const match = buttonText.match(/^(.+?)\s\d+/);
            if (match && match[1]) {
              bookName = match[1].trim();
            }
          }

          // Get plain text content
          let fullText = verseDiv.textContent || '';
          const supText = supElement.textContent || '';
          let plainText = fullText.replace(supText, '').trim();

          if (!isNaN(chapter) && !isNaN(verseNum)) {
            allVerseData.push({ book: bookName, chapter, verse: verseNum, text: plainText });
          }
        });

        // 3. Group verses by book and chapter
        const groupedVerses = allVerseData.reduce((acc, verse) => {
          acc[verse.book] = acc[verse.book] || {};
          acc[verse.book][verse.chapter] = acc[verse.book][verse.chapter] || [];
          acc[verse.book][verse.chapter].push({ verse: verse.verse, text: verse.text });
          return acc;
        }, {});

        let finalOutput = [];
        let listOfHeaders = [];

        // 4. Generate consolidated reference string per chapter and format output blocks
        for (const book in groupedVerses) {
          let verseInBook = [];

          for (const chapter in groupedVerses[book]) {
            // All selected verses for this specific book and chapter, sorted
            const versesInChapter = groupedVerses[book][chapter].sort((a, b) => a.verse - b.verse);

            // Generate the consolidated reference string (e.g., "4, 6-8, 10")
            const referenceString = generateVerseReferenceString(versesInChapter.map(v => v.verse));

            // Format the block using the consolidated reference and all verses for the chapter
            const text = formatChapterBlock(book, chapter, referenceString, versesInChapter, translation);
            finalOutput.push(text);

            verseInBook.push({ chapter: chapter, verses: referenceString });
          }

          listOfHeaders.push({ book: book, verses: verseInBook });
        }

        // Helper function to generate comma-separated verse/range string
        function generateVerseReferenceString(verseNumbers) {
          if (!verseNumbers || verseNumbers.length === 0) return '';

          let result = [];
          let rangeStart = verseNumbers[0];

          for (let i = 0; i < verseNumbers.length; i++) {
            const currentVerse = verseNumbers[i];
            const nextVerse = verseNumbers[i + 1];

            // Check if the next verse is not consecutive or if it's the last verse
            if (nextVerse !== currentVerse + 1 || i === verseNumbers.length - 1) {
              if (currentVerse === rangeStart) {
                // Single verse
                result.push(`${rangeStart}`);
              } else {
                // Range of verses
                result.push(`${rangeStart}-${currentVerse}`);
              }
              // Start a new range if there are more verses
              if (nextVerse) {
                rangeStart = nextVerse;
              }
            }
          }
          return result.join(', ');
        }

        // Helper function to format a block for a whole chapter's selection
        function formatChapterBlock(book, chapter, referenceString, versesData, translation) {
          let header = `${book} ${chapter}:${referenceString} (${translation})`;
          let lines;
          if (boldCopyEnabled) {
            header = toUnicodeBold(`${book} ${chapter}:${referenceString} (${translation})`);
            // Include text for all selected verses in this chapter, sorted, with bold verse numbers
            lines = versesData.map(v => `${toUnicodeBold(v.verse.toString())} ${v.text}`);
          } else {
            // Include text for all selected verses in this chapter, sorted
            lines = versesData.map(v => `${v.verse} ${v.text}`);
          }
          return header + '\n' + lines.join('\n');
        }

        function formatBibleHeader(data) {
          const result = data.map(entry => {
            const book = entry.book;
            const versesGroup = entry.verses.map(v => `${v.chapter}:${v.verses}`);
            return `${book} ${versesGroup.join(', ')}`;
          });
          return result.join(', ') + ` (${translation})`;
        }

        // 6. Combine blocks
        const formattedText = finalOutput.join('\n\n');
        const formattedHeader = formatBibleHeader(listOfHeaders);

        return { formattedText, formattedHeader };
      }
    }

    // Copy verse functionality
    document.getElementById('copy-verse').addEventListener('click', function () {
      const { formattedText, _ } = formatVerseSelection(selectedVerses);

      // Copy to Clipboard
      navigator.clipboard.writeText(formattedText)
        .then(() => {
          // GA Event
          if (typeof gtag === 'function') {
            const truncatedText = formattedText.substring(0, 100);
            gtag('event', 'share', {
              'method': 'copy',
              'content_type': 'bible_verse_formatted_multi', // New type for multi-block
              'item_id': truncatedText,
              'selected_version': translation
            });
          }
          // Show feedback
          const originalText = this.innerHTML;
          this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>Copied!';
          setTimeout(() => { this.innerHTML = originalText; }, 2000);
        })
        .catch(err => {
          console.error('Failed to copy multi-block formatted text: ', err);
        });

    });

    document.addEventListener("DOMContentLoaded", function () {
      const popoverBtn = document.getElementById("popoverBtn");
      const popoverContent = document.getElementById("popoverContent");

      document.addEventListener("click", function (event) {
        // Check if the click target is not inside the popover and not the button that triggers the popover
        if (
          !popoverContent.contains(event.target) &&
          event.target !== popoverBtn
        ) {
          popoverContent.style.display = "none";
        }
      });

      function getVisibleWidth(el) {
        // Save the original styles
        const originalStyle = el.getAttribute("style");
        el.style.display = "block"; // Display the element
        el.style.position = "absolute"; // Position it off-screen
        el.style.left = "-9999px";
        const width = el.offsetWidth; // Get the width
        el.setAttribute("style", originalStyle); // Reset the styles to their original state
        return width;
      }

      popoverBtn.addEventListener("click", function () {
        const isHidden = getComputedStyle(popoverContent).display === "none";

        // GA Event (Track toggle action)
        if (typeof gtag === 'function') {
          gtag('event', 'toggle_settings', {
            'ui_element': 'settings_button',
            'selected_version': getCurrentVersion()
          });
        }

        // Get width of the popover when it's visible
        const popoverWidth = getVisibleWidth(popoverContent);

        // Get the screen width
        const screenWidth = window.innerWidth;

        // Position the popover to the left of the button and aligned to its top edge
        const rect = popoverBtn.getBoundingClientRect();

        // Calculate left position based on screen width
        let leftPosition = rect.left - popoverWidth + window.scrollX;

        // If the screen is wide, adjust the left position based on the centered .fixed-width-large element
        if (screenWidth >= 992) {
          leftPosition = 674;
        }

        popoverContent.style.top = `${rect.top + window.scrollY}px`;
        popoverContent.style.left = `${leftPosition}px`;

        if (isHidden) {
          // First make it visible but with opacity 0
          popoverContent.style.display = "block";

          // Force a reflow to ensure the transition works
          popoverContent.offsetHeight;

          // Then add the show class to trigger the animation
          popoverContent.classList.add("show");
        } else {
          // Remove the show class first to trigger the fade out
          popoverContent.classList.remove("show");

          // After the transition completes, hide the element
          setTimeout(() => {
            popoverContent.style.display = "none";
          }, 300); // Match this with the transition duration in CSS
        }
      });
    });

    // Font size slider option

    document.addEventListener("DOMContentLoaded", function () {
      const fontSizeSlider = document.getElementById("font-size-slider");

      // Map slider values to font size classes
      const fontSizeMap = {
        "1": "small-font-size",
        "2": "medium-font-size",
        "3": "large-font-size"
      };

      fontSizeSlider.addEventListener("input", function () {
        const value = this.value;
        const newFontSizeClass = fontSizeMap[value];
        const oldFontSizeClass = fontSize;

        document.querySelectorAll(".verse-div").forEach((element) => {
          element.className = "verse-div"; // Reset class first
          // element.classList.remove(oldFontSizeClass); // Removing specific class might be brittle if state is inconsistent
          element.classList.add(newFontSizeClass);
        });

        fontSize = newFontSizeClass;
        setCookie("fontSize", fontSize, 365);

        // GA Event
        if (typeof gtag === 'function') {
          gtag('event', 'change_setting', {
            'setting_type': 'font_size',
            'setting_value': newFontSizeClass,
            'selected_version': getCurrentVersion()
          });
        }
      });
    });

    // Dark mode toggle option

    document.addEventListener("DOMContentLoaded", function () {
      const modeToggle = document.getElementById("mode-toggle");

      modeToggle.addEventListener("change", function () {
        const mode = this.checked ? "dark" : "light";
        document.documentElement.dataset.bsTheme = mode;

        let lastButtonMode = modeToButton[currentMode];
        let newButtonMode = modeToButton[mode];

        // Update all buttons with the new mode styling
        document
          .querySelectorAll(`.btn-${lastButtonMode}`)
          .forEach((element) => {
            if (!element.classList.contains("mode-btn")) {
              element.classList.remove(`btn-${lastButtonMode}`);
              element.classList.add(`btn-${newButtonMode}`);
            }
          });

        document
          .querySelectorAll(`.btn-outline-${lastButtonMode}`)
          .forEach((element) => {
            element.classList.remove(`btn-outline-${lastButtonMode}`);
            element.classList.add(`btn-outline-${newButtonMode}`);
          });

        currentMode = mode;
        setCookie("mode", mode, 365);

        // For popover
        const popoverContent = document.getElementById("popoverContent");
        if (popoverContent) { // Check if popover exists
          if (mode === "dark") {
            popoverContent.classList.add("dark-mode");
          } else {
            popoverContent.classList.remove("dark-mode");
          }
        }

        // GA Event
        if (typeof gtag === 'function') {
          gtag('event', 'change_setting', {
            'setting_type': 'theme',
            'setting_value': mode,
            'selected_version': getCurrentVersion()
          });
        }
      });
    });

    // Apply saved settings from cookies on page load
    document.addEventListener("DOMContentLoaded", function () {
      const modeCookie = getCookie("mode");
      const fontSizeCookie = getCookie("fontSize");
      const modeToggle = document.getElementById("mode-toggle");
      const boldCopyToggle = document.getElementById("bold-copy-toggle");
      const fontSizeSlider = document.getElementById("font-size-slider");

      // Apply dark/light mode
      if (modeCookie === "dark") {
        modeToggle.checked = true;
        document.documentElement.dataset.bsTheme = "dark";
        currentMode = "dark"; // Update state variable
        // Apply dark mode styling adjustments if needed (e.g., for popover)
        const popoverContent = document.getElementById("popoverContent");
        if (popoverContent) popoverContent.classList.add("dark-mode");
        // Note: Button class updates might need manual trigger if not handled by bsTheme change
      } else {
        // Default is light, ensure checkbox is unchecked
        modeToggle.checked = false;
        document.documentElement.dataset.bsTheme = "light";
        currentMode = "light"; // Update state variable
      }

      // Apply font size
      const fontSizeMap = {
        "small-font-size": "1",
        "medium-font-size": "2",
        "large-font-size": "3"
      };
      const sliderValue = fontSizeMap[fontSizeCookie] || "2"; // Default to medium
      fontSizeSlider.value = sliderValue;
      fontSize = fontSizeCookie || "medium-font-size"; // Update state variable

      // Apply the font size class to existing verse divs (if any are loaded initially)
      // This might be redundant if fetchVerses runs after this and applies it anyway
      document.querySelectorAll(".verse-div").forEach((element) => {
        element.className = "verse-div"; // Reset classes
        element.classList.add(fontSize);
      });

      // Apply bold copy setting (default to true if cookie not set or is 'true')
      const boldCopyCookie = getCookie("boldCopy");
      if (boldCopyCookie === "false") { // Only disable if explicitly set to false
        boldCopyToggle.checked = false;
        boldCopyEnabled = false;
      } else { // Default to true or if cookie is 'true'
        boldCopyToggle.checked = true;
        boldCopyEnabled = true;
      }

      // --- GA Event Listeners ---

      // Accordion Button Click (using event delegation)
      const versesOutput = document.getElementById('verses-output');
      if (versesOutput) {
        versesOutput.addEventListener('click', function (event) {
          const button = event.target.closest('.accordion-button');
          if (button && typeof gtag === 'function') {
            gtag('event', 'select_content', {
              'content_type': 'bible_book_chapter',
              'item_id': button.textContent.trim(), // Get text like "Genesis 1:1-16"
              'selected_version': getCurrentVersion()
            });
          }
        });
      }

      // Scroll to Top Button Click
      const scrollToTopBtn = document.getElementById('scrollToTopBtn');
      if (scrollToTopBtn) {
        // Remove existing onclick attribute if present (optional, but cleaner)
        // scrollToTopBtn.removeAttribute('onclick');

        scrollToTopBtn.addEventListener('click', function () {
          scrollToTop(); // Call the existing scroll function
          // GA Event
          if (typeof gtag === 'function') {
            gtag('event', 'scroll_to_top', {
              'ui_element': 'scroll_top_button',
              'selected_version': getCurrentVersion()
            });
          }
        });
      }
      // --- End GA Event Listeners ---

      // --- Bold Copy Toggle Listener ---
      if (boldCopyToggle) {
        boldCopyToggle.addEventListener('change', function () {
          boldCopyEnabled = this.checked;
          setCookie("boldCopy", boldCopyEnabled, 365);
          // GA Event (Optional: Track if this setting change is valuable)
          if (typeof gtag === 'function') {
            gtag('event', 'change_setting', {
              'setting_type': 'bold_copy',
              'setting_value': boldCopyEnabled,
              'selected_version': getCurrentVersion()
            });
          }
        });
      }
      // --- End Bold Copy Toggle Listener ---

      // --- Engagement Heartbeat ---
      function sendEngagementHeartbeat() {
        // Only send if the tab is visible and gtag is available
        if (!document.hidden && typeof gtag === 'function') {
          gtag('event', 'user_heartbeat', {
            'event_category': 'engagement',
            'event_label': 'active_tab',
            'non_interaction': true, // Important: Mark as non-interaction to avoid affecting bounce rate
            'selected_version': getCurrentVersion() // Add context
          });
        }
      }

      // Send heartbeat every 30 seconds
      setInterval(sendEngagementHeartbeat, 30000);
      // --- End Engagement Heartbeat ---

    });
  </script>
  <button id="scrollToTopBtn" class="btn btn-dark" onclick="scrollToTop()" aria-label="Scroll to top">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
      <path
        d="M7.646 4.646a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 6.207V11.5a.5.5 0 0 1-1 0V6.207L5.354 8.354a.5.5 0 1 1-.708-.708l3-3z" />
    </svg>
  </button>
  <div id="verseSelectionHeader" class="verse-selection-header">
    <div id="verseSelectionHeaderContent" class="content"></div>
  </div>

</body>

</html>