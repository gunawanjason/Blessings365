<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alkitab365 - Compare Versions</title>
    <link rel="icon" type="image/x-icon" href="/assets/bcc.ico" />
    <link rel="apple-touch-icon" href="/assets/bcc.ico" />
    <style>
      /* Basic styling for readability */
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .comparison-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        width: 100%;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        padding-bottom: 20px;
        align-items: flex-start;
      }
      .version-panel {
        min-width: 0;
        scroll-snap-align: start;
        flex: 1 1 0;
        width: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background-color: var(--bs-body-bg);
      }

      /* Ensure accordion items align vertically between panels */
      .accordion-item {
        margin-bottom: 0;
      }

      /* Synchronize accordion heights between panels */
      .accordion-collapse {
        min-height: 0;
      }

      /* Ensure verse divs have consistent spacing */
      .verse-div {
        margin-bottom: 0.5rem;
        line-height: 1.6;
      }

      /* Align accordion headers */
      .accordion-header {
        margin-bottom: 0;
      }

      .accordion-button {
        padding: 0.75rem 1rem;
      }

      /* Ensure consistent accordion body padding */
      .accordion-body {
        padding: 1rem;
      }
      .version-header {
        font-weight: bold;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--bs-primary);
        color: var(--bs-primary);
      }
      .popover {
        display: none;
        position: absolute;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 0.3rem;
        max-width: 276px;
        z-index: 1070;
        background-color: var(--bs-body-bg);
        transition: opacity 0.3s ease;
        opacity: 0;
      }
      .popover.show {
        opacity: 1;
      }
      .popover-header {
        padding: 0.5rem 1rem;
        margin: 0;
        border-bottom: 1px solid var(--bs-border-color);
        font-size: 1rem;
        font-weight: 500;
        background-color: var(--bs-tertiary-bg);
      }
      .popover-body {
        padding: 1rem;
      }
      .settings-btn {
        padding: 0.5rem;
        line-height: 1;
        border: 1px solid var(--bs-border-color);
        background-color: transparent;
        border-radius: 0.375rem;
      }
      .settings-btn:hover {
        background-color: var(--bs-tertiary-bg);
      }
      @media (max-width: 768px) {
        .version-panel {
          min-width: 0;
          flex-basis: 100%;
          width: 100%;
        }
        @media (max-width: 768px) {
          .version-panel {
            min-width: calc(97vw - 40px);
            flex: 0 0 auto;
            width: auto;
          }
        }
      }
    </style>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <link rel="stylesheet" type="text/css" href="verse-menu.css" />
    <style>
      /* Popover transition animation */
      .popover {
        transition: opacity 0.3s ease-in-out;
      }
      .popover.show {
        opacity: 1;
      }

      /* Enhanced verse alignment for comparison */
      .comparison-container {
        position: relative;
      }

      /* Ensure both panels have synchronized heights */
      #versesAccordion1,
      #versesAccordion2 {
        display: flex;
        flex-direction: column;
      }

      /* Make accordion items flex to maintain alignment */
      #versesAccordion1 .accordion-item,
      #versesAccordion2 .accordion-item {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: fit-content;
      }

      /* Ensure headers have consistent height */
      #versesAccordion1 .accordion-header,
      #versesAccordion2 .accordion-header {
        min-height: 3rem;
        display: flex;
        align-items: center;
      }

      /* Ensure button text wraps consistently */
      #versesAccordion1 .accordion-button,
      #versesAccordion2 .accordion-button {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-height: 3rem;
        display: flex;
        align-items: center;
      }

      /* Ensure verses in expanded sections align */
      #versesAccordion1 .accordion-collapse.show,
      #versesAccordion2 .accordion-collapse.show {
        display: flex;
        flex-direction: column;
      }

      /* Better verse spacing for alignment */
      .verse-div {
        padding: 0.25rem 0;
        border: none;
        background: transparent;
      }

      /* Ensure consistent line heights */
      .verse-div.small-font-size {
        line-height: 1.4;
      }

      .verse-div.medium-font-size {
        line-height: 1.6;
      }

      .verse-div.large-font-size {
        line-height: 1.8;
      }

      /* Verse selection highlighting - same as index.html */
      .verse-selected {
        background-color: rgba(108, 117, 125, 0.15);
        position: relative;
        transition: background-color 0.3s ease;
        border-left: 3px solid #0d6efd;
        padding-left: 7px;
      }

      /* Remove hover effects when verse is selected */
      .verse-div:hover:not(.verse-selected) {
        background-color: var(--bs-tertiary-bg);
        border-radius: 0.375rem;
        padding: 0.5rem;
        margin: 0.25rem 0;
      }
    </style>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
      integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8="
      crossorigin="anonymous"
    ></script>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-MBVE1FKX3R"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-MBVE1FKX3R");
    </script>
  </head>

  <body>
    <div class="fixed-width-container">
      <nav class="mt-4 mb-4 navbar navbar-expand-lg fixed-width-large">
        <div class="container-fluid popover-container">
          <a href="index.html" class="navbar-brand mb-0 h1">
            Alkitab<span class="brand-accent">365</span>
          </a>
          <div class="d-flex">
            <a href="index.html" class="btn btn-outline-primary me-2">Daily</a>
            <button id="popoverBtn" class="btn settings-btn">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                class="bi"
                fill="currentColor"
                viewBox="0 0 16 16"
              >
                <path
                  fill-rule="evenodd"
                  d="M2.5 11.5A.5.5 0 0 1 3 11h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 7h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 3h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"
                ></path>
              </svg>
            </button>
          </div>
          <div class="popover" id="popoverContent">
            <div class="popover-header">Reader settings</div>
            <div class="popover-body">
              <!-- Font size option -->
              <div class="user-options font-size-option">
                <p class="mb-0">Font size</p>
                <div class="font-size-slider-container">
                  <input
                    type="range"
                    min="1"
                    max="3"
                    value="2"
                    step="1"
                    class="font-size-slider"
                    id="font-size-slider"
                  />
                  <div class="font-size-labels">
                    <span
                      ><span class="font-size-example small-font-size">Aa</span>
                      Small</span
                    >
                    <span
                      ><span class="font-size-example medium-font-size"
                        >Aa</span
                      >
                      Medium</span
                    >
                    <span
                      ><span class="font-size-example large-font-size">Aa</span>
                      Large</span
                    >
                  </div>
                </div>
              </div>

              <!-- Dark mode option -->
              <div class="user-options toggle-option">
                <p class="mb-0">Appearance</p>
                <label class="toggle-label">
                  <span class="toggle-icon">‚òÄÔ∏è</span>
                  <div class="toggle-switch">
                    <input type="checkbox" id="mode-toggle" />
                    <span class="toggle-slider"></span>
                  </div>
                  <span class="toggle-icon">üåô</span>
                </label>
              </div>

              <!-- Bold Copy option -->
              <div class="user-options toggle-option">
                <p class="mb-0">Copy Format</p>
                <label class="toggle-label">
                  <span class="toggle-icon">Aa</span>
                  <!-- Plain text icon -->
                  <div class="toggle-switch">
                    <input type="checkbox" id="bold-copy-toggle" />
                    <span class="toggle-slider"></span>
                  </div>
                  <span class="toggle-icon"><strong>A</strong>a</span>
                  <!-- Better bold icon -->
                </label>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </div>

    <div class="fixed-width-container">
      <div class="d-flex justify-content-center align-items-center mb-3">
        <h2 class="text-center mb-0">Compare Bible Versions</h2>
      </div>

      <!-- Date and Version Selectors -->
      <div class="d-flex justify-content-center fixed-width-medium">
        <div class="me-2">
          <label for="month-selector" class="selector-label">Date</label>
          <select id="month-selector" class="form-select-sm"></select>
        </div>
        <div class="me-3">
          <label for="day-selector" class="selector-label"></label>
          <select id="day-selector" class="form-select-sm"></select>
        </div>
      </div>

      <!-- Version Selectors for Comparison -->
      <div class="d-flex justify-content-center fixed-width-medium mt-3">
        <div class="me-3">
          <label for="translation-selector-1" class="selector-label"
            >Version 1</label
          >
          <select id="translation-selector-1" class="form-select-sm">
            <option value="TB">TB</option>
            <option value="ESV" selected>ESV</option>
            <option value="KJV">KJV</option>
            <option value="NASB">NASB</option>
            <option value="NIV">NIV</option>
            <option value="NLT">NLT</option>
            <option value="TLB">TLB</option>
            <option value="CNVS">Êñ∞ËØëÊú¨(CNVS)</option>
            <option value="CUNPSS-‰∏äÂ∏ù">Êñ∞Ê†áÁÇπÂíåÂêàÊú¨Ôºå‰∏äÂ∏ùÁâà</option>
            <option value="CUNPSS-Á•û">Êñ∞Ê†áÁÇπÂíåÂêàÊú¨ÔºåÁ•ûÁâà</option>
          </select>
        </div>
        <div>
          <label for="translation-selector-2" class="selector-label"
            >Version 2</label
          >
          <select id="translation-selector-2" class="form-select-sm">
            <option value="TB" selected>TB</option>
            <option value="ESV">ESV</option>
            <option value="KJV">KJV</option>
            <option value="NASB">NASB</option>
            <option value="NIV">NIV</option>
            <option value="NLT">NLT</option>
            <option value="TLB">TLB</option>
            <option value="CNVS">Êñ∞ËØëÊú¨(CNVS)</option>
            <option value="CUNPSS-‰∏äÂ∏ù">Êñ∞Ê†áÁÇπÂíåÂêàÊú¨Ôºå‰∏äÂ∏ùÁâà</option>
            <option value="CUNPSS-Á•û">Êñ∞Ê†áÁÇπÂíåÂêàÊú¨ÔºåÁ•ûÁâà</option>
          </select>
        </div>
      </div>
    </div>

    <hr class="mt-3 mb-3" />

    <!-- Comparison Display -->
    <div class="fixed-width-container">
      <div class="comparison-container">
        <div class="version-panel">
          <div class="version-header" id="version-1-header">ESV</div>
          <div id="verses-output-1" class="verses-content"></div>
        </div>
        <div class="version-panel">
          <div class="version-header" id="version-2-header">TB</div>
          <div id="verses-output-2" class="verses-content"></div>
        </div>
      </div>

      <!-- Verse menu for sharing and copying (simplified) -->
      <div id="verse-menu" class="verse-menu">
        <!-- Menu items can be added here for other functions if needed -->
      </div>
    </div>

    <!-- Footer with copy functionality -->
    <footer id="main-footer" class="main-footer">
      <div class="footer-content">
        <button
          id="copy-verse"
          class="btn btn-outline-primary copy-button"
          disabled
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            width="14"
            height="14"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
            />
          </svg>
          Copy
        </button>
        <div class="footer-info">
          <span id="selection-count">Select verses to copy</span>
        </div>
      </div>
    </footer>

    <script>
      // Initialize theme and reader settings from localStorage immediately
      const savedMode = localStorage.getItem("mode");
      const mode = savedMode || "light";
      document.documentElement.dataset.bsTheme = mode;

      // Initialize reader settings UI state
      const popoverContent = document.getElementById("popoverContent");
      if (mode === "dark" && popoverContent) {
        popoverContent.classList.add("dark-mode");
        document.getElementById("mode-toggle").checked = true;
      }

      // States for theme handling
      let currentMode = mode;
      const modeToButton = {
        light: "dark",
        dark: "light",
      };

      // Helper function to get current Bible version
      function getCurrentVersion() {
        const selector = document.getElementById("translation-selector-1");
        return selector ? selector.value : "unknown"; // Handle case where selector might not exist yet
      }

      // Import shared functionality from the main app
      const englishToIndonesianBooks = {
        Genesis: "Kejadian",
        Exodus: "Keluaran",
        Leviticus: "Imamat",
        Numbers: "Bilangan",
        Deuteronomy: "Ulangan",
        Joshua: "Yosua",
        Judges: "Hakim-Hakim",
        Ruth: "Rut",
        "1 Samuel": "1 Samuel",
        "2 Samuel": "2 Samuel",
        "1 Kings": "1 Raja-Raja",
        "2 Kings": "2 Raja-Raja",
        "1 Chronicles": "1 Tawarikh",
        "2 Chronicles": "2 Tawarikh",
        Ezra: "Ezra",
        Nehemiah: "Nehemia",
        Esther: "Ester",
        Job: "Ayub",
        Psalms: "Mazmur",
        Proverbs: "Amsal",
        Ecclesiastes: "Pengkhotbah",
        "Song of Solomon": "Kidung Agung",
        Isaiah: "Yesaya",
        Jeremiah: "Yeremia",
        Lamentations: "Ratapan",
        Ezekiel: "Yehezkiel",
        Daniel: "Daniel",
        Hosea: "Hosea",
        Joel: "Yoel",
        Amos: "Amos",
        Obadiah: "Obaja",
        Jonah: "Yunus",
        Micah: "Mikha",
        Nahum: "Nahum",
        Habakkuk: "Habakuk",
        Zephaniah: "Zefanya",
        Haggai: "Hagai",
        Zechariah: "Zakharia",
        Malachi: "Maleakhi",
        Matthew: "Matius",
        Mark: "Markus",
        Luke: "Lukas",
        John: "Yohanes",
        Acts: "Kisah Para Rasul",
        Romans: "Roma",
        "1 Corinthians": "1 Korintus",
        "2 Corinthians": "2 Korintus",
        Galatians: "Galatia",
        Ephesians: "Efesus",
        Philippians: "Filipi",
        Colossians: "Kolose",
        "1 Thessalonians": "1 Tesalonika",
        "2 Thessalonians": "2 Tesalonika",
        "1 Timothy": "1 Timotius",
        "2 Timothy": "2 Timotius",
        Titus: "Titus",
        Philemon: "Filemon",
        Hebrews: "Ibrani",
        James: "Yakobus",
        "1 Peter": "1 Petrus",
        "2 Peter": "2 Petrus",
        "1 John": "1 Yohanes",
        "2 John": "2 Yohanes",
        "3 John": "3 Yohanes",
        Jude: "Yudas",
        Revelation: "Wahyu",
      };

      const englishToChineseBooks = {
        Genesis: "Âàõ‰∏ñÁ∫™",
        Exodus: "Âá∫ÂüÉÂèäËÆ∞",
        Leviticus: "Âà©Êú™ËÆ∞",
        Numbers: "Ê∞ëÊï∞ËÆ∞",
        Deuteronomy: "Áî≥ÂëΩËÆ∞",
        Joshua: "Á∫¶‰π¶‰∫öËÆ∞",
        Judges: "Â£´Â∏àËÆ∞",
        Ruth: "Ë∑ØÂæóËÆ∞",
        "1 Samuel": "ÊííÊØçËÄ≥ËÆ∞‰∏ä",
        "2 Samuel": "ÊííÊØçËÄ≥ËÆ∞‰∏ã",
        "1 Kings": "ÂàóÁéãËÆ∞‰∏ä",
        "2 Kings": "ÂàóÁéãËÆ∞‰∏ã",
        "1 Chronicles": "ÂéÜ‰ª£Âøó‰∏ä",
        "2 Chronicles": "ÂéÜ‰ª£Âøó‰∏ã",
        Ezra: "‰ª•ÊñØÊãâËÆ∞",
        Nehemiah: "Â∞ºÂ∏åÁ±≥ËÆ∞",
        Esther: "‰ª•ÊñØÂ∏ñËÆ∞",
        Job: "Á∫¶‰ºØËÆ∞",
        Psalms: "ËØóÁØá",
        Proverbs: "ÁÆ¥Ë®Ä",
        Ecclesiastes: "‰º†ÈÅì‰π¶",
        "Song of Solomon": "ÈõÖÊ≠å",
        Isaiah: "‰ª•Ëµõ‰∫ö‰π¶",
        Jeremiah: "ËÄ∂Âà©Á±≥‰π¶",
        Lamentations: "ËÄ∂Âà©Á±≥ÂìÄÊ≠å",
        Ezekiel: "‰ª•Ë•øÁªì‰π¶",
        Daniel: "‰ΩÜ‰ª•ÁêÜ‰π¶",
        Hosea: "‰ΩïË•øÈòø‰π¶",
        Joel: "Á∫¶Áè•‰π¶",
        Amos: "ÈòøÊë©Âè∏‰π¶",
        Obadiah: "‰øÑÂ∑¥Â∫ï‰∫ö‰π¶",
        Jonah: "Á∫¶Êãø‰π¶",
        Micah: "Âº•Ëø¶‰π¶",
        Nahum: "ÈÇ£È∏ø‰π¶",
        Habakkuk: "ÂìàÂ∑¥Ë∞∑‰π¶",
        Zephaniah: "Ë•øÁï™ÈõÖ‰π¶",
        Haggai: "ÂìàËØ•‰π¶",
        Zechariah: "ÊííËø¶Âà©‰∫ö‰π¶",
        Malachi: "ÁéõÊãâÂü∫‰π¶",
        Matthew: "È©¨Â§™Á¶èÈü≥",
        Mark: "È©¨ÂèØÁ¶èÈü≥",
        Luke: "Ë∑ØÂä†Á¶èÈü≥",
        John: "Á∫¶Áø∞Á¶èÈü≥",
        Acts: "‰ΩøÂæíË°å‰º†",
        Romans: "ÁΩóÈ©¨‰π¶",
        "1 Corinthians": "Ê≠åÊûóÂ§öÂâç‰π¶",
        "2 Corinthians": "Ê≠åÊûóÂ§öÂêé‰π¶",
        Galatians: "Âä†ÊãâÂ§™‰π¶",
        Ephesians: "‰ª•ÂºóÊâÄ‰π¶",
        Philippians: "ËÖìÂà©ÊØî‰π¶",
        Colossians: "Ê≠åÁΩóË•ø‰π¶",
        "1 Thessalonians": "Â∏ñÊííÁΩóÂ∞ºËø¶Ââç‰π¶",
        "2 Thessalonians": "Â∏ñÊííÁΩóÂ∞ºËø¶Âêé‰π¶",
        "1 Timothy": "ÊèêÊë©Â§™Ââç‰π¶",
        "2 Timothy": "ÊèêÊë©Â§™Âêé‰π¶",
        Titus: "ÊèêÂ§ö‰π¶",
        Philemon: "ËÖìÂà©Èó®‰π¶",
        Hebrews: "Â∏å‰ºØÊù•‰π¶",
        James: "ÈõÖÂêÑ‰π¶",
        "1 Peter": "ÂΩºÂæóÂâç‰π¶",
        "2 Peter": "ÂΩºÂæóÂêé‰π¶",
        "1 John": "Á∫¶Áø∞‰∏Ä‰π¶",
        "2 John": "Á∫¶Áø∞‰∫å‰π¶",
        "3 John": "Á∫¶Áø∞‰∏â‰π¶",
        Jude: "ÁäπÂ§ß‰π¶",
        Revelation: "ÂêØÁ§∫ÂΩï",
      };

      // Cookie management functions
      function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + exdays * 24 * 60 * 60 * 1000);
        let expires = "expires=" + d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
      }

      function getCookie(cname) {
        let name = cname + "=";
        let ca = document.cookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) == " ") {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
      }

      let translatedData = {};
      let boldCopyEnabled = true;
      let currentSelectedText = "";
      let fontSize = "medium-font-size"; // Default font size
      let isAccordionSyncing = false; // Sync control flag

      function isLeapYear(year) {
        return (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0;
      }

      function dayOfYear(date) {
        const start = new Date(date.getFullYear(), 0, 0);
        const diff =
          date -
          start +
          (start.getTimezoneOffset() - date.getTimezoneOffset()) * 60 * 1000;
        const oneDay = 1000 * 60 * 60 * 24;
        let day = Math.floor(diff / oneDay);

        // Adjust day count in leap years after February 29
        if (
          isLeapYear(date.getFullYear()) &&
          ((date.getMonth() === 1 && date.getDate() === 29) ||
            date.getMonth() > 1)
        ) {
          day -= 1;
        }

        return day;
      }

      function populateMonthDayDropdowns() {
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];
        const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

        const monthSelector = document.getElementById("month-selector");
        const daySelector = document.getElementById("day-selector");

        monthNames.forEach((month, index) => {
          const option = document.createElement("option");
          option.value = index + 1;
          option.textContent = month;
          monthSelector.appendChild(option);
        });

        function fillDays() {
          daySelector.innerHTML = "";
          const selectedMonth = parseInt(monthSelector.value);
          const currentYear = new Date().getFullYear();
          if (isLeapYear(currentYear) && selectedMonth === 2) {
            daysInMonth[selectedMonth - 1] = 29;
          }
          for (let i = 1; i <= daysInMonth[selectedMonth - 1]; i++) {
            const option = document.createElement("option");
            option.value = i;
            option.textContent = i;
            daySelector.appendChild(option);
          }
        }

        fillDays();

        monthSelector.addEventListener("change", () => {
          fillDays();
          fetchBothVersions();
        });

        daySelector.addEventListener("change", () => {
          fetchBothVersions();
        });

        // Set to today's date
        const today = new Date();
        monthSelector.value = today.getMonth() + 1;
        fillDays();
        daySelector.value = today.getDate();

        if (
          isLeapYear(today.getFullYear()) &&
          today.getMonth() === 1 &&
          today.getDate() === 29
        ) {
          daySelector.value = 29;
        }
      }

      function formatBookName(bookName) {
        // Split the input into words
        const words = bookName.split(" ");

        // Initialize an array for non-numeric parts and numeric parts
        const nonNumericParts = [];
        const numericParts = [];

        // Separate non-numeric and numeric parts
        for (const word of words) {
          if (isNaN(word)) {
            nonNumericParts.push(word);
          } else {
            numericParts.push(word);
          }
        }

        // Join the non-numeric parts with hyphens and add the numeric parts at the end
        const formattedString =
          nonNumericParts.join("-").toLowerCase() + numericParts.join("");

        return formattedString;
      }

      function addVerseSelectionListeners(container) {
        container.addEventListener("mouseup", function () {
          const selection = window.getSelection();
          if (selection.toString().trim().length > 0) {
            currentSelectedText = selection.toString().trim();
          }
        });
      }

      function displayVerses(data, translation, panelNumber) {
        const outputDiv = document.getElementById(
          `verses-output-${panelNumber}`
        );
        const headerDiv = document.getElementById(
          `version-${panelNumber}-header`
        );

        outputDiv.innerHTML = "";
        headerDiv.textContent = translation;

        const accordionDiv = document.createElement("div");
        accordionDiv.classList.add("accordion", "accordion-flush");
        accordionDiv.setAttribute("id", `versesAccordion${panelNumber}`);
        outputDiv.appendChild(accordionDiv);

        let currentBookDisplay = ""; // Stores the display name of the book being processed
        let currentBookOriginalForId = ""; // Stores the original name (e.g., English) for ID generation

        let currentItem, currentBody;

        let startVerse = ""; // Start verse of the current book passage
        let prevVerse = ""; // Last verse processed in the current book passage

        // Variables to hold details of the *previous* book section for updating its title
        let prevAccordionButton = null;
        let prevBookDisplayTitle = "";
        let prevBookStartVerse = "";
        let prevBookLastVerse = "";

        for (const verseData of data) {
          const bookName = verseData.bookName; // Potentially translated book name for display
          const originalBookName = verseData.originalBookName || bookName; // Original name for IDs
          const chapterNumber = verseData.chapterNumber;
          const verseNumber = verseData.verseNumber;
          const text = verseData.text;

          if (originalBookName !== currentBookOriginalForId) {
            // This is a new book. Finalize the title of the *previous* book section.
            if (prevAccordionButton) {
              let tempPrevBookLastVerseText = prevBookLastVerse;
              if (
                prevBookStartVerse.split(":")[0] ===
                tempPrevBookLastVerseText.split(":")[0]
              ) {
                tempPrevBookLastVerseText =
                  tempPrevBookLastVerseText.split(":")[1];
              }
              prevAccordionButton.textContent = `${prevBookDisplayTitle} ${prevBookStartVerse}-${tempPrevBookLastVerseText}`;
            }

            // Start new accordion item for the current book
            currentItem = document.createElement("div");
            currentItem.classList.add("accordion-item");
            accordionDiv.appendChild(currentItem);

            const baseId = formatBookName(originalBookName); // Use original name for ID
            const headerId = `${baseId}-heading-${panelNumber}`;
            const buttonId = `${baseId}-button-${panelNumber}`;
            const collapseId = `${baseId}-collapse-${panelNumber}`;

            let currentHeader = document.createElement("h2");
            currentHeader.classList.add("accordion-header");
            currentHeader.setAttribute("id", headerId);
            currentItem.appendChild(currentHeader);

            let currentButton = document.createElement("button");
            currentButton.className = "accordion-button collapsed";
            currentButton.type = "button";
            currentButton.setAttribute("data-bs-toggle", "collapse");
            currentButton.setAttribute("data-bs-target", `#${collapseId}`);
            currentButton.setAttribute("aria-expanded", "false");
            currentButton.setAttribute("aria-controls", collapseId);
            currentButton.setAttribute("id", buttonId);
            currentButton.setAttribute("data-original-book", originalBookName);
            currentButton.textContent = bookName; // Initial title is just the book name
            currentHeader.appendChild(currentButton);

            let currentCollapse = document.createElement("div");
            currentCollapse.className = "accordion-collapse collapse";
            currentCollapse.setAttribute("id", collapseId);
            currentCollapse.setAttribute("aria-labelledby", headerId);
            currentItem.appendChild(currentCollapse);

            currentBody = document.createElement("div");
            currentBody.className = "accordion-body";
            currentCollapse.appendChild(currentBody);

            // Accordion sync logic (existing)
            currentButton.addEventListener("click", function (event) {
              if (isAccordionSyncing) return;
              setTimeout(() => {
                if (isAccordionSyncing) return;
                isAccordionSyncing = true;
                try {
                  const currentCollapseElement =
                    document.getElementById(collapseId);
                  const parts = collapseId.split("-");
                  const bookBaseId = parts.slice(0, -2).join("-");
                  const currentPanelNum = parseInt(parts[parts.length - 1]);
                  const otherPanelNum = currentPanelNum === 1 ? 2 : 1;
                  const otherCollapseId = `${bookBaseId}-collapse-${otherPanelNum}`;
                  const otherCollapseElement =
                    document.getElementById(otherCollapseId);
                  const otherButton = document.querySelector(
                    `[data-bs-target="#${otherCollapseId}"]`
                  );
                  if (otherCollapseElement && otherButton) {
                    const isCurrentExpanded =
                      currentCollapseElement.classList.contains("show") ||
                      !currentButton.classList.contains("collapsed");
                    const isOtherExpanded =
                      otherCollapseElement.classList.contains("show") ||
                      !otherButton.classList.contains("collapsed");
                    if (isCurrentExpanded && !isOtherExpanded) {
                      otherCollapseElement.classList.add("show");
                      otherButton.classList.remove("collapsed");
                      otherButton.setAttribute("aria-expanded", "true");
                    } else if (!isCurrentExpanded && isOtherExpanded) {
                      otherCollapseElement.classList.remove("show");
                      otherButton.classList.add("collapsed");
                      otherButton.setAttribute("aria-expanded", "false");
                    }
                  }
                } catch (e) {
                  console.error("Error during accordion sync:", e);
                }
                setTimeout(() => {
                  isAccordionSyncing = false;
                }, 100);
              }, 10);
            });
            currentCollapse.addEventListener(
              "shown.bs.collapse",
              function (event) {
                if (isAccordionSyncing) return;
                syncAccordionState(event.target.id, true);
                // Synchronize verse heights after accordion is shown
                setTimeout(() => {
                  synchronizeVerseHeights();
                }, 50);
              }
            );
            currentCollapse.addEventListener(
              "hidden.bs.collapse",
              function (event) {
                if (isAccordionSyncing) return;
                syncAccordionState(event.target.id, false);
                // Synchronize verse heights after accordion is hidden
                setTimeout(() => {
                  synchronizeVerseHeights();
                }, 50);
              }
            );
            // End of accordion sync logic

            // Update trackers for the new book section
            currentBookDisplay = bookName;
            currentBookOriginalForId = originalBookName;
            startVerse = `${chapterNumber}:${verseNumber}`;

            // Store details for this new button, to be updated when the *next* book starts or at the end
            prevAccordionButton = currentButton;
            prevBookDisplayTitle = bookName; // Display name for this book
            prevBookStartVerse = startVerse; // Start verse for this book
          }

          const verseDiv = document.createElement("div");
          verseDiv.className = `verse-div ${fontSize}`;
          verseDiv.innerHTML = `<strong><sup>${chapterNumber}:${verseNumber}</sup></strong> ${text}`;
          currentBody.appendChild(verseDiv);

          prevVerse = `${chapterNumber}:${verseNumber}`; // Keep track of the last verse of the current book section
          prevBookLastVerse = prevVerse; // Update the last verse for the current book section being built
        }

        // After the loop, update the title for the very last book section processed
        if (prevAccordionButton) {
          // Check if any book was processed
          let tempPrevBookLastVerseText = prevBookLastVerse;
          if (
            prevBookStartVerse &&
            prevBookStartVerse.split(":")[0] ===
              tempPrevBookLastVerseText.split(":")[0]
          ) {
            tempPrevBookLastVerseText = tempPrevBookLastVerseText.split(":")[1];
          }
          prevAccordionButton.textContent = `${prevBookDisplayTitle} ${prevBookStartVerse}-${tempPrevBookLastVerseText}`;
        }

        addVerseSelectionListeners(outputDiv);
      }

      // Helper function to sync accordion state between panels
      function syncAccordionState(collapseId, isExpanded) {
        if (isAccordionSyncing) return;
        isAccordionSyncing = true;

        try {
          const parts = collapseId.split("-");
          const bookBaseId = parts.slice(0, -2).join("-");
          const currentPanel = parseInt(parts[parts.length - 1]);
          const otherPanel = currentPanel === 1 ? 2 : 1;
          const otherCollapseId = `${bookBaseId}-collapse-${otherPanel}`;
          const otherCollapse = document.getElementById(otherCollapseId);
          const otherButton = document.querySelector(
            `[data-bs-target="#${otherCollapseId}"]`
          );

          if (otherCollapse && otherButton) {
            const isOtherExpanded = otherCollapse.classList.contains("show");

            if (isExpanded && !isOtherExpanded) {
              // Expand the other panel to match
              otherCollapse.classList.add("show");
              otherButton.classList.remove("collapsed");
              otherButton.setAttribute("aria-expanded", "true");
            } else if (!isExpanded && isOtherExpanded) {
              // Collapse the other panel to match
              otherCollapse.classList.remove("show");
              otherButton.classList.add("collapsed");
              otherButton.setAttribute("aria-expanded", "false");
            }
          }
        } catch (e) {
          console.error("Error in syncAccordionState:", e);
        }

        setTimeout(() => {
          isAccordionSyncing = false;
        }, 50);
      }

      // Function to synchronize verse heights between panels
      function synchronizeVerseHeights() {
        const panel1 = document.getElementById("versesAccordion1");
        const panel2 = document.getElementById("versesAccordion2");

        if (!panel1 || !panel2) return;

        // Get all accordion items from both panels
        const items1 = panel1.querySelectorAll(".accordion-item");
        const items2 = panel2.querySelectorAll(".accordion-item");

        // Synchronize accordion item heights
        for (let i = 0; i < Math.max(items1.length, items2.length); i++) {
          const item1 = items1[i];
          const item2 = items2[i];

          if (item1 && item2) {
            // Reset heights first
            item1.style.minHeight = "auto";
            item2.style.minHeight = "auto";

            // Get natural heights
            const height1 = item1.offsetHeight;
            const height2 = item2.offsetHeight;
            const maxHeight = Math.max(height1, height2);

            // Apply max height to both
            item1.style.minHeight = maxHeight + "px";
            item2.style.minHeight = maxHeight + "px";
          }
        }

        // Synchronize verse divs within expanded accordion bodies
        const expandedBodies1 = panel1.querySelectorAll(
          ".accordion-collapse.show .accordion-body"
        );
        const expandedBodies2 = panel2.querySelectorAll(
          ".accordion-collapse.show .accordion-body"
        );

        expandedBodies1.forEach((body1, index) => {
          const body2 = expandedBodies2[index];
          if (body2) {
            const verses1 = body1.querySelectorAll(".verse-div");
            const verses2 = body2.querySelectorAll(".verse-div");

            for (let i = 0; i < Math.max(verses1.length, verses2.length); i++) {
              const verse1 = verses1[i];
              const verse2 = verses2[i];

              if (verse1 && verse2) {
                // Reset heights
                verse1.style.minHeight = "auto";
                verse2.style.minHeight = "auto";

                // Get natural heights
                const verseHeight1 = verse1.offsetHeight;
                const verseHeight2 = verse2.offsetHeight;
                const maxVerseHeight = Math.max(verseHeight1, verseHeight2);

                // Apply max height
                verse1.style.minHeight = maxVerseHeight + "px";
                verse2.style.minHeight = maxVerseHeight + "px";
              }
            }
          }
        });
      }

      async function fetchBothVersions() {
        const version1 = document.getElementById(
          "translation-selector-1"
        ).value;
        const version2 = document.getElementById(
          "translation-selector-2"
        ).value;

        try {
          // Fetch both versions in parallel but wait for both to complete
          await Promise.all([
            fetchVerses(version1, 1),
            fetchVerses(version2, 2),
          ]);

          // Synchronize verse heights after both panels are loaded
          setTimeout(() => {
            synchronizeVerseHeights();
          }, 100);
        } catch (error) {
          console.error("Error fetching verses:", error);
        }
      }

      async function fetchVerses(translation, panelNumber) {
        const selectedMonth = parseInt(
          document.getElementById("month-selector").value
        );
        const selectedDay = parseInt(
          document.getElementById("day-selector").value
        );
        const date = new Date(
          new Date().getFullYear(),
          selectedMonth - 1,
          selectedDay
        );
        const dayOfYearValue = dayOfYear(date);

        const translatedData = JSON.parse(
          localStorage.getItem("translatedData")
        );
        if (!translatedData) {
          document.getElementById(`verses-output-${panelNumber}`).innerHTML =
            "<p>Error: Bible reading data not found. Please reload the page.</p>";
          return;
        }

        const references = translatedData[dayOfYearValue];
        if (!references) {
          document.getElementById(`verses-output-${panelNumber}`).innerHTML =
            "<p>No references found for this date.</p>";
          return;
        }

        const verses = references.join(",");

        // Show loading indicator
        const outputDiv = document.getElementById(
          `verses-output-${panelNumber}`
        );
        outputDiv.innerHTML = `
          <div class="d-flex justify-content-center my-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        `;

        const apiUrl = `https://api.blessings365.top/${translation}/multiple?verses=${encodeURIComponent(
          verses
        )}`;

        try {
          const response = await fetch(apiUrl);
          const data = await response.json();

          const allVerses = data.map((verse) => {
            let translatedBookName = verse.book;

            if (translation === "TB") {
              translatedBookName =
                englishToIndonesianBooks[verse.book] || verse.book;
            } else if (
              translation.includes("CNV") ||
              translation.includes("CUN")
            ) {
              translatedBookName =
                englishToChineseBooks[verse.book] || verse.book;
            }

            return {
              text: verse.content,
              bookName: translatedBookName,
              originalBookName: verse.book, // Keep original English book name
              chapterNumber: verse.chapter,
              verseNumber: verse.verse,
            };
          });

          // Ensure synchronous execution of displayVerses
          await new Promise((resolve) => {
            setTimeout(() => {
              displayVerses(allVerses, translation, panelNumber);
              resolve();
            }, 0);
          });
        } catch (error) {
          console.error("Error fetching verses:", error);
          outputDiv.innerHTML = `
            <div class="alert alert-danger" role="alert">
              Error loading verses. Please try again.
            </div>
          `;
          throw error; // Re-throw to be caught by Promise.all
        }
      }

      // Event listeners for version selectors
      document
        .getElementById("translation-selector-1")
        .addEventListener("change", fetchBothVersions);

      document
        .getElementById("translation-selector-2")
        .addEventListener("change", fetchBothVersions);

      // Load the translated data and initialize
      (async function initialize() {
        try {
          const response = await fetch("Translated_Bacaan_Alkitab_365.json");
          const data = await response.json();
          translatedData = data;
          populateMonthDayDropdowns();
          await fetchBothVersions();
        } catch (error) {
          console.error("Error loading translated data:", error);
        }
      })();

      // Handle verse selection and footer
      let selectedVerses = [];
      let selectedVersesAddress = "";
      let verseMenu, footer, selectionCount;

      // Close verse menu when clicking outside
      document.addEventListener("click", function (e) {
        if (
          !e.target.closest(".verse-div") &&
          !e.target.closest("#verse-menu")
        ) {
          verseMenu.style.display = "none";
          // Clear all selections when clicking outside
          selectedVerses.forEach((verse) => {
            verse.classList.remove("verse-selected");
          });
          selectedVerses = [];
          updateFooterVisibility();
        }
      });

      function updateFooterVisibility() {
        if (!footer || !selectionCount) return;

        const copyButton = document.getElementById("copy-verse");
        if (!copyButton) return;

        if (selectedVerses.length > 0) {
          footer.classList.add("show");
          copyButton.disabled = false;

          // Show only the count, no addresses
          const count = selectedVerses.length;
          const verseText = count === 1 ? "verse" : "verses";
          selectionCount.textContent = `${count} ${verseText} selected`;
        } else {
          footer.classList.remove("show");
          copyButton.disabled = true;
          selectionCount.textContent = "Select verses to copy";
        }
      }

      // Handle verse click to show footer
      document.addEventListener("click", function (e) {
        const verseDiv = e.target.closest(".verse-div");
        if (verseDiv) {
          e.preventDefault();

          // Toggle selection for the clicked verse
          if (selectedVerses.includes(verseDiv)) {
            verseDiv.classList.remove("verse-selected");
            selectedVerses = selectedVerses.filter((v) => v !== verseDiv);
          } else {
            verseDiv.classList.add("verse-selected");
            selectedVerses.push(verseDiv);
          }

          // Update verse address selection and footer
          if (selectedVerses.length > 0) {
            const { formattedText, formattedHeader } =
              formatVerseSelection(selectedVerses);
            selectedVersesAddress = formattedHeader || "";
            resetCopyButton(); // Reset the copy button state
          }

          // Always hide the verse menu since we're using footer
          verseMenu.style.display = "none";
          updateFooterVisibility();
        }
      });

      // Unicode bold mapping
      const boldMap = {
        A: "ùóî",
        B: "ùóï",
        C: "ùóñ",
        D: "ùóó",
        E: "ùóò",
        F: "ùóô",
        G: "ùóö",
        H: "ùóõ",
        I: "ùóú",
        J: "ùóù",
        K: "ùóû",
        L: "ùóü",
        M: "ùó†",
        N: "ùó°",
        O: "ùó¢",
        P: "ùó£",
        Q: "ùó§",
        R: "ùó•",
        S: "ùó¶",
        T: "ùóß",
        U: "ùó®",
        V: "ùó©",
        W: "ùó™",
        X: "ùó´",
        Y: "ùó¨",
        Z: "ùó≠",
        a: "ùóÆ",
        b: "ùóØ",
        c: "ùó∞",
        d: "ùó±",
        e: "ùó≤",
        f: "ùó≥",
        g: "ùó¥",
        h: "ùóµ",
        i: "ùó∂",
        j: "ùó∑",
        k: "ùó∏",
        l: "ùóπ",
        m: "ùó∫",
        n: "ùóª",
        o: "ùóº",
        p: "ùóΩ",
        q: "ùóæ",
        r: "ùóø",
        s: "ùòÄ",
        t: "ùòÅ",
        u: "ùòÇ",
        v: "ùòÉ",
        w: "ùòÑ",
        x: "ùòÖ",
        y: "ùòÜ",
        z: "ùòá",
        0: "ùü¨",
        1: "ùü≠",
        2: "ùüÆ",
        3: "ùüØ",
        4: "ùü∞",
        5: "ùü±",
        6: "ùü≤",
        7: "ùü≥",
        8: "ùü¥",
        9: "ùüµ",
        " ": " ",
        ":": ":",
        "-": "-",
        "(": "(",
        ")": ")",
        ",": ",",
        ".": ".",
      };

      function toUnicodeBold(str) {
        return str
          .split("")
          .map((char) => boldMap[char] || char)
          .join("");
      }

      function formatVerseSelection(selectedVerses, translation) {
        if (selectedVerses.length > 0) {
          // Sort verses by their position in the document
          const sortedVerses = [...selectedVerses].sort((a, b) => {
            const position = a.compareDocumentPosition(b);
            if (position & Node.DOCUMENT_POSITION_FOLLOWING) return -1;
            if (position & Node.DOCUMENT_POSITION_PRECEDING) return 1;
            return 0;
          });

          const allVerseData = [];

          // Extract detailed info for each verse
          sortedVerses.forEach((verseDiv) => {
            const supElement = verseDiv.querySelector("sup");
            if (!supElement) return;

            const chapterVerse = supElement.textContent;
            const [chapterStr, verseStr] = chapterVerse.split(":");
            const chapter = parseInt(chapterStr, 10);
            const verseNum = parseInt(verseStr, 10);

            // Get book name and translation from the version header
            const versionPanel = verseDiv.closest(".version-panel");
            const versionHeader = versionPanel.querySelector(".version-header");

            // Use the translation's appropriate book name based on version
            const verseElement = verseDiv.closest(".verse-div");
            const accordionItem = verseDiv.closest(".accordion-item");
            const button = accordionItem.querySelector(".accordion-button");
            const originalBookName = button.getAttribute("data-original-book"); // This is always the English name

            // Get translation from selector based on panel number
            const versesOutputDiv = versionPanel.querySelector(
              '[id^="verses-output-"]'
            ); // Find child like verses-output-1 or verses-output-2
            const panelNumber =
              versesOutputDiv && versesOutputDiv.id.includes("1") ? 1 : 2;
            const currentTranslationAbbreviation = document.getElementById(
              `translation-selector-${panelNumber}`
            ).value;

            let translatedBookName = originalBookName; // Default to original
            if (
              currentTranslationAbbreviation === "TB" &&
              englishToIndonesianBooks[originalBookName]
            ) {
              translatedBookName = englishToIndonesianBooks[originalBookName];
            } else if (
              currentTranslationAbbreviation === "CUV" &&
              englishToChineseBooks[originalBookName]
            ) {
              translatedBookName = englishToChineseBooks[originalBookName];
            }
            // Add other translation maps here if needed

            // Get plain text content
            let fullText = verseDiv.textContent || "";
            const supText = supElement.textContent || "";
            let plainText = fullText.replace(supText, "").trim();
            const buttonId = button.id;
            // Find the verse data object that corresponds to this verse
            const verseKey = `${
              buttonId.split("-")[0]
            }-${chapterStr}-${verseStr}`;

            allVerseData.push({
              book: translatedBookName, // Use the translated book name
              chapter,
              verse: verseNum,
              text: plainText,
              translation: currentTranslationAbbreviation, // Use the translation from the panel
            });
          });

          // Group verses by book, then chapter, then translation
          const groupedVerses = allVerseData.reduce((acc, verse) => {
            acc[verse.book] = acc[verse.book] || {};
            acc[verse.book][verse.chapter] =
              acc[verse.book][verse.chapter] || {};
            acc[verse.book][verse.chapter][verse.translation] =
              acc[verse.book][verse.chapter][verse.translation] || [];
            // Store the full verse object
            acc[verse.book][verse.chapter][verse.translation].push(verse);
            return acc;
          }, {});

          let finalOutput = [];

          // Generate consolidated reference string per chapter and format output blocks
          for (const book in groupedVerses) {
            for (const chapter in groupedVerses[book]) {
              for (const translation in groupedVerses[book][chapter]) {
                // Iterate through translations
                // Sort verses by verse number for this specific book, chapter, and translation
                const versesInBlock = groupedVerses[book][chapter][
                  translation
                ].sort((a, b) => a.verse - b.verse);

                if (versesInBlock.length === 0) continue;

                // The translation for√ü this block is simply the 'translation' key from our loop
                const translationForThisBlock = translation;

                const referenceString = generateVerseReferenceString(
                  versesInBlock.map((v) => v.verse) // Extracts verse numbers for reference string
                );

                const text = formatChapterBlock(
                  book,
                  chapter,
                  referenceString,
                  versesInBlock, // Pass the array of {verse, text, translation} for this specific block
                  translationForThisBlock // Pass the specific translation for this block's header
                );
                finalOutput.push(text);
              }
            }
          }

          function generateVerseReferenceString(verseNumbers) {
            if (!verseNumbers || verseNumbers.length === 0) return "";

            let result = [];
            let rangeStart = verseNumbers[0];

            for (let i = 0; i < verseNumbers.length; i++) {
              const currentVerse = verseNumbers[i];
              const nextVerse = verseNumbers[i + 1];

              if (
                nextVerse !== currentVerse + 1 ||
                i === verseNumbers.length - 1
              ) {
                if (currentVerse === rangeStart) {
                  result.push(`${rangeStart}`);
                } else {
                  result.push(`${rangeStart}-${currentVerse}`);
                }
                if (nextVerse) {
                  rangeStart = nextVerse;
                }
              }
            }
            return result.join(", ");
          }

          function formatChapterBlock(
            book,
            chapter,
            referenceString,
            versesData,
            translation
          ) {
            let header = `${book} ${chapter}:${referenceString} (${translation})`;
            let lines;
            if (boldCopyEnabled) {
              header = toUnicodeBold(header);
              lines = versesData.map(
                (v) => `${toUnicodeBold(v.verse.toString())} ${v.text}`
              );
            } else {
              // When bold copy is disabled, keep everything as normal text
              header = header; // Keep header as plain text
              lines = versesData.map((v) => `${v.verse} ${v.text}`);
            }
            return header + "\n" + lines.join("\n");
          }

          const formattedText = finalOutput.join("\n\n");

          // Generate a simple header showing selected verses for footer display
          let formattedHeader = "";
          if (allVerseData.length > 0) {
            // Group by book for header display
            const bookGroups = {};
            allVerseData.forEach((verse) => {
              if (!bookGroups[verse.book]) {
                bookGroups[verse.book] = [];
              }
              bookGroups[verse.book].push(`${verse.chapter}:${verse.verse}`);
            });

            const headerParts = [];
            for (const book in bookGroups) {
              headerParts.push(`${book} ${bookGroups[book].join(", ")}`);
            }
            formattedHeader = headerParts.join("; ");
          }

          return { formattedText, formattedHeader };
        }
      }

      // Enhanced copy verse functionality with fallback (improved from index.html)
      let copyButtonTimeout = null;
      let copyButton, originalButtonText;
      const successIcon =
        '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
      const errorIcon =
        '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';

      function resetCopyButton() {
        if (copyButtonTimeout) {
          clearTimeout(copyButtonTimeout);
          copyButtonTimeout = null;
        }
        if (copyButton && originalButtonText) {
          copyButton.innerHTML = originalButtonText;
        }
      }

      // Reset button when new verse is selected
      document.addEventListener("verseSelected", resetCopyButton);

      function attachCopyButtonListener() {
        copyButton = document.getElementById("copy-verse");
        if (!copyButton) return;

        originalButtonText = copyButton.innerHTML;

        copyButton.addEventListener("click", async function () {
          const { formattedText } = formatVerseSelection(selectedVerses);
          resetCopyButton(); // Reset any previous state

          try {
            // Try modern clipboard API first
            if (navigator.clipboard) {
              await navigator.clipboard.writeText(formattedText);
            } else {
              // Fallback for older browsers
              const textarea = document.createElement("textarea");
              textarea.value = formattedText;
              textarea.style.position = "fixed"; // Prevent scrolling to bottom
              document.body.appendChild(textarea);
              textarea.select();

              if (!document.execCommand("copy")) {
                throw new Error("Copy command failed");
              }
              document.body.removeChild(textarea);
            }

            // GA Event (only if gtag is available)
            if (typeof gtag === "function") {
              try {
                const truncatedText = formattedText.substring(0, 100);
                const eventData = {
                  method: "copy",
                  content_type: "bible_verse_formatted_multi_compare",
                  item_id: truncatedText,
                };
                gtag("event", "share", eventData);
              } catch (gaErr) {
                console.warn("GA tracking failed:", gaErr);
              }
            }

            // Show success feedback
            copyButton.innerHTML = `${successIcon}Copied`;
            copyButtonTimeout = setTimeout(() => {
              copyButton.innerHTML = originalButtonText;
              copyButtonTimeout = null;
            }, 2000);
          } catch (err) {
            console.error("Copy failed:", err);
            // Show error feedback
            copyButton.innerHTML = `${errorIcon}Failed to copy`;
            copyButtonTimeout = setTimeout(() => {
              copyButton.innerHTML = originalButtonText;
              copyButtonTimeout = null;
            }, 2000);
          }
        });
      }

      // Settings functionality
      document.addEventListener("DOMContentLoaded", function () {
        const fontSizeCookie = getCookie("fontSize");
        const modeCookie = getCookie("mode");
        const boldCopyCookie = getCookie("boldCopy");
        const modeToggle = document.getElementById("mode-toggle");
        const boldCopyToggle = document.getElementById("bold-copy-toggle");
        const fontSizeSlider = document.getElementById("font-size-slider");

        // Initialize footer elements
        verseMenu = document.getElementById("verse-menu");
        footer = document.getElementById("main-footer");
        selectionCount = document.getElementById("selection-count");
        copyButton = document.getElementById("copy-verse");
        if (copyButton) {
          originalButtonText = copyButton.innerHTML;
        }

        // Initialize copy button functionality
        attachCopyButtonListener();

        // Initialize bold copy setting from cookie
        if (boldCopyCookie !== "") {
          boldCopyEnabled = boldCopyCookie === "true";
          boldCopyToggle.checked = boldCopyEnabled;
        }

        // Add event listener for bold copy toggle
        if (boldCopyToggle) {
          boldCopyToggle.addEventListener("change", function () {
            boldCopyEnabled = this.checked;
            setCookie("boldCopy", boldCopyEnabled.toString(), 365);

            // GA Event
            if (typeof gtag === "function") {
              gtag("event", "change_setting", {
                setting_type: "bold_copy",
                setting_value: boldCopyEnabled ? "enabled" : "disabled",
              });
            }
          });
        }

        // Apply font size
        const fontSizeMap = {
          "small-font-size": "1",
          "medium-font-size": "2",
          "large-font-size": "3",
        };

        if (fontSizeCookie) {
          const sliderValue = fontSizeMap[fontSizeCookie] || "2"; // Default to medium
          fontSizeSlider.value = sliderValue;
          fontSize = fontSizeCookie;

          // Apply the font size class to existing verse divs
          document.querySelectorAll(".verse-div").forEach((element) => {
            element.className = "verse-div"; // Reset classes
            element.classList.add(fontSize);
          });
        }

        // Font size slider
        if (fontSizeSlider) {
          fontSizeSlider.addEventListener("input", function () {
            const value = this.value;
            const fontSizeMap = {
              1: "small-font-size",
              2: "medium-font-size",
              3: "large-font-size",
            };
            const newFontSizeClass = fontSizeMap[value];
            const oldFontSizeClass = fontSize;

            document.querySelectorAll(".verse-div").forEach((element) => {
              element.className = "verse-div"; // Reset class first
              element.classList.add(newFontSizeClass);
            });

            fontSize = newFontSizeClass;
            setCookie("fontSize", fontSize, 365);

            // GA Event
            if (typeof gtag === "function") {
              gtag("event", "change_setting", {
                setting_type: "font_size",
                setting_value: newFontSizeClass,
              });
            }
          });
        }

        // Dark mode toggle initialization from localStorage
        const savedTheme = localStorage.getItem("mode");
        if (savedTheme === "dark") {
          modeToggle.checked = true;
          document.documentElement.dataset.bsTheme = "dark";
          currentMode = "dark";
        } else {
          modeToggle.checked = false;
          document.documentElement.dataset.bsTheme = "light";
          currentMode = "light";
        }

        if (modeToggle) {
          modeToggle.addEventListener("change", function () {
            const mode = this.checked ? "dark" : "light";
            document.documentElement.dataset.bsTheme = mode;

            let lastButtonMode = modeToButton[currentMode];
            let newButtonMode = modeToButton[mode];

            // Update all buttons with the new mode styling
            document
              .querySelectorAll(`.btn-${lastButtonMode}`)
              .forEach((element) => {
                if (!element.classList.contains("mode-btn")) {
                  element.classList.remove(`btn-${lastButtonMode}`);
                  element.classList.add(`btn-${newButtonMode}`);
                }
              });

            document
              .querySelectorAll(`.btn-outline-${lastButtonMode}`)
              .forEach((element) => {
                element.classList.remove(`btn-outline-${lastButtonMode}`);
                element.classList.add(`btn-outline-${newButtonMode}`);
              });

            currentMode = mode;
            localStorage.setItem("mode", mode);

            // For popover
            const popoverContent = document.getElementById("popoverContent");
            if (popoverContent) {
              if (mode === "dark") {
                popoverContent.classList.add("dark-mode");
              } else {
                popoverContent.classList.remove("dark-mode");
              }
            }

            // GA Event
            if (typeof gtag === "function") {
              gtag("event", "change_setting", {
                setting_type: "theme",
                setting_value: mode,
              });
            }
          });
        }

        // Popover functionality
        const popoverBtn = document.getElementById("popoverBtn");
        const popoverContent = document.getElementById("popoverContent");

        if (popoverBtn && popoverContent) {
          function getVisibleWidth(el) {
            // Save the original styles
            const originalStyle = el.getAttribute("style");
            el.style.display = "block"; // Display the element
            el.style.position = "absolute"; // Position it off-screen
            el.style.left = "-9999px";
            const width = el.offsetWidth; // Get the width
            el.setAttribute("style", originalStyle); // Reset the styles
            return width;
          }

          popoverBtn.addEventListener("click", function () {
            const isHidden =
              getComputedStyle(popoverContent).display === "none";

            // GA Event
            if (typeof gtag === "function") {
              gtag("event", "toggle_settings", {
                ui_element: "settings_button",
              });
            }

            // Get width of the popover when it's visible
            const popoverWidth = getVisibleWidth(popoverContent);

            // Get the screen width
            const screenWidth = window.innerWidth;

            // Position the popover to the left of the button and aligned to its top edge
            const rect = popoverBtn.getBoundingClientRect();

            // Calculate left position based on screen width
            let leftPosition = rect.left - popoverWidth + window.scrollX;

            // If the screen is wide, adjust the left position based on the centered .fixed-width-large element
            if (screenWidth >= 992) {
              leftPosition = 674;
            }

            popoverContent.style.top = `${rect.top + window.scrollY}px`;
            popoverContent.style.left = `${leftPosition}px`;

            if (isHidden) {
              // First make it visible but with opacity 0
              popoverContent.style.display = "block";
              // Force a reflow to ensure the transition works
              popoverContent.offsetHeight;
              // Then add the show class to trigger the animation
              popoverContent.classList.add("show");
            } else {
              // Remove the show class first to trigger the fade out
              popoverContent.classList.remove("show");
              // After the transition completes, hide the element
              setTimeout(() => {
                popoverContent.style.display = "none";
              }, 300); // Match this with the transition duration in CSS
            }
          });

          // Close popover when clicking outside
          document.addEventListener("click", function (event) {
            if (
              !popoverBtn.contains(event.target) &&
              !popoverContent.contains(event.target)
            ) {
              // Remove the show class first to trigger the fade out
              popoverContent.classList.remove("show");
              // After the transition completes, hide the element
              setTimeout(() => {
                popoverContent.style.display = "none";
              }, 300); // Match this with the transition duration in CSS
            }
          });
        }
      });
    </script>
  </body>
</html>
